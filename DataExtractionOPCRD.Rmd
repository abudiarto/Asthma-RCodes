---
title: "R Notebook"
output: html_notebook
---
This file will run the analysis pipeline to get patient data, and then analyze

# Step 1: Patient Selection (Find the list of eligible patients:2016-2018)

```{r}
rm(list=ls())
## load the libraries you will need
library(tictoc)
library(dplyr)
library(config)
library(RODBC)
library(tidyverse)
## set up the database connection
dw <- config::get()
con <- odbcConnect("opcrd_dsn", uid=dw$uid, pwd=dw$pwd)

## now get the list of definite asthma codes (Quint's previous publication)
#library(readstata13)
#definite_asthma_codes=readstata13::read.dta13('Asthma READ Codes/asthma do files/definite_asthma_codes.dta')
definite_asthma_codes = read.delim('asthma_codes_specific.txt', sep = ',')
medcodes=read.delim('medical.txt')
definite_asthma_codes <-definite_asthma_codes %>%
  left_join(medcodes, by='medcode')
# remove the term id and keep only the read code
definite_asthma_codes<-definite_asthma_codes %>%
  mutate(readcode_new=substr(readcode,1,5))
definite_asthma_codes <-definite_asthma_codes %>%
  select(medcode,readcode,readcode_new,readterm)

# query the database now
# use the codes used by Quint et al. to find cohort (from 2016 - 2018)
queryCohortPool=paste("SELECT * FROM [OPC_Client_Research].[dbo].[f_clinical] WHERE (event_date >= '2016-01-1') AND (event_date < '2019-1-1') AND code_id IN ('", paste(definite_asthma_codes$readcode_new,collapse='\',\''),"')",sep='')
tic()
sample_result <- sqlQuery(con,queryCohortPool)
toc()
fclinical_selected_2016_2018=sample_result
## save the results
save(fclinical_selected_2016_2018,file='fclinical_selected_2016_2018_13Oct2020.Rdata')
## also, get the list of patients from the f_clinical
selectedPatients<-fclinical_selected_2016_2018 %>%
  group_by(patid) %>%
  filter(row_number()==1)%>%
  select(patid)
save(selectedPatients,file='selectedPatients_13Oct2020.Rdata')
```
# Step 2A: Now that the above block has been run, you will have a list of patients for whom you will download all the data for these selected patients until 31/12/2018

```{r}
## clear workspace and load libraries
rm(list=ls())
library(config)
library(RODBC)
library(tictoc)
library(dplyr)
## set up the database connection
dw <- config::get()
con <- odbcConnect("opcrd_dsn", uid=dw$uid, pwd=dw$pwd)
## load the selected paients (IDs)
load('selectedPatients_13Oct2020.Rdata')

## set parameters for downloading
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
data_folder='ServerData_13Oct2020'


## download f_clinical

foreach (kc = 1:num_files, .packages=c('tictoc', 'dplyr', 'RODBC'), .verbose = TRUE)%dopar%{
  tic()
  dw <- config::get()
  con <- odbcConnect("opcrd_dsn", uid=dw$uid, pwd=dw$pwd)
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  iA=(kc-1)*chunk_size+1
  iB=min(num_patients,(kc*chunk_size))
  patients_subset=selectedPatients$patid[iA:iB]
  myquery=paste("SELECT * FROM [OPC_Client_Research].[dbo].[f_clinical] WHERE (event_date < '2019-1-1') AND patid IN ('", paste(patients_subset,collapse='\',\''),"')",sep='')
  
  f_clinical_part <- sqlQuery(con,myquery)
 save(f_clinical_part,file=paste(data_folder,'/f_clinical_part',kc,'.Rdata',sep='')) 
 toc()
}

## download f_therapy
foreach (kc = 1:num_files, .packages=c('tictoc', 'dplyr', 'RODBC'), .verbose = TRUE)%dopar%{
  tic()
  dw <- config::get()
  con <- odbcConnect("opcrd_dsn", uid=dw$uid, pwd=dw$pwd)
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  iA=(kc-1)*chunk_size+1
  iB=min(num_patients,(kc*chunk_size))
  patients_subset=selectedPatients$patid[iA:iB]
  myquery=paste("SELECT * FROM [OPC_Client_Research].[dbo].[f_therapy] WHERE (event_date < '2019-1-1') AND patid IN ('", paste(patients_subset,collapse='\',\''),"')",sep='')
  
  f_therapy_part <- sqlQuery(con,myquery)
 save(f_therapy_part,file=paste(data_folder,'/f_therapy_part',kc,'.Rdata',sep='')) 
 toc()
}

## download f_referral
foreach (kc = 1:num_files, .packages=c('tictoc', 'dplyr', 'RODBC'), .verbose = TRUE)%dopar%{
  tic()
  dw <- config::get()
  con <- odbcConnect("opcrd_dsn", uid=dw$uid, pwd=dw$pwd)
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  iA=(kc-1)*chunk_size+1
  iB=min(num_patients,(kc*chunk_size))
  patients_subset=selectedPatients$patid[iA:iB]
  myquery=paste("SELECT * FROM [OPC_Client_Research].[dbo].[f_referral] WHERE (event_date < '2019-1-1') AND patid IN ('", paste(patients_subset,collapse='\',\''),"')",sep='')
  
  f_referral_part <- sqlQuery(con,myquery)
 save(f_referral_part,file=paste(data_folder,'/f_referral_part',kc,'.Rdata',sep='')) 
 toc()
}

## download d_patient
foreach (kc = 1:num_files, .packages=c('tictoc', 'dplyr', 'RODBC'), .verbose = TRUE)%dopar%{
  tic()
  dw <- config::get()
  con <- odbcConnect("opcrd_dsn", uid=dw$uid, pwd=dw$pwd)
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  iA=(kc-1)*chunk_size+1
  iB=min(num_patients,(kc*chunk_size))
  patients_subset=selectedPatients$patid[iA:iB]
  myquery=paste("SELECT * FROM [OPC_Client_Research].[dbo].[d_patient] WHERE patid IN ('", paste(patients_subset,collapse='\',\''),"')",sep='')
  
  d_patient_part <- sqlQuery(con,myquery)
 save(d_patient_part,file=paste(data_folder,'/d_patient_part',kc,'.Rdata',sep='')) 
 toc()
}

## combine the d_patient_parts into one single file
load(paste(data_folder,'/d_patient_part',1,'.Rdata',sep='')) 
d_patient_overall=d_patient_part
for (kc in c(2:num_files)){
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  iA=(kc-1)*chunk_size+1
  iB=min(num_patients,(kc*chunk_size))
  patients_subset=selectedPatients[iA:iB,]
  load(paste(data_folder,'/d_patient_part',kc,'.Rdata',sep='')) 
  d_patient_overall=rbind(d_patient_overall,d_patient_part)
  rm(d_patient_part)
}
save(d_patient_overall,file=paste(data_folder,'/d_patient_overall.Rdata',sep=''))
#now also download the remaining relevant tables

## d_extraction
myquery="SELECT * FROM [OPC_Client_Research].[dbo].[d_extraction]"
d_extraction <- sqlQuery(con,myquery)
save(d_extraction,file=paste(data_folder,'/d_extraction.Rdata',sep = ''))

## d_practice
myquery="SELECT * FROM [OPC_Client_Research].[dbo].[d_practice]"
d_practice <- sqlQuery(con,myquery)
save(d_practice,file=paste(data_folder,'/d_practice.Rdata',sep = ''))

## OPC_Client_Research_overview
myquery="SELECT * FROM [OPC_Client_Research].[dbo].[OPC_Client_Research_overview]"
data_overview <- sqlQuery(con,myquery)
save(data_overview,file=paste(data_folder,'data_overview.Rdata',sep=''))

## d_dosage_v2
myquery="SELECT * FROM [OPC_Client_Research].[dbo].[d_dosage_v2]"
d_dosage <- sqlQuery(con,myquery)
save(d_dosage,file=paste(data_folder,'/d_dosage.Rdata',sep = ''))
```
# let us also add the country information to practice id here
```{r}
rm(list=ls())
library(dplyr)
data_folder='ServerData_13Oct2020'
load(paste(data_folder,'/d_practice.Rdata',sep=''))
ONS_PostCodes=read.csv('./National_Statistics_Postcode_Lookup_UK.csv')

num_practices=length(d_practice$postcode_district)
d_practice <-d_practice %>%
  mutate('England'=0,'Scotland'=0,'NIreland'=0,'Wales'=0)%>%
  mutate('Country'='','County'='','LocalAuthority'='','Region'='','PrimaryCareTrust'='','OutputAreaClassification'='')

for (kp in c(1:num_practices)){
  print(paste('Processing practice:',kp))
  ID=which(startsWith(as.character(ONS_PostCodes$Postcode.1),as.character(d_practice$postcode_district[kp])))
  Table_Countries=table(ONS_PostCodes$Country.Name[ID])
  if(!is_empty(Table_Countries)){
    d_practice$England[kp]=Table_Countries['England']
    d_practice$NIreland[kp]=Table_Countries['Northern Ireland']
    d_practice$Scotland[kp]=Table_Countries['Scotland']
    d_practice$Wales[kp]=Table_Countries['Wales']
    
    d_practice$Country[kp]=tail(names(sort(table(ONS_PostCodes$Country.Name[ID]))),1)
    # the others may be approximation
    d_practice$County[kp]=tail(names(sort(table(ONS_PostCodes$County.Name[ID]))),1)
    d_practice$LocalAuthority[kp]=tail(names(sort(table(ONS_PostCodes$Local.Authority.Name[ID]))),1)
    d_practice$Region[kp]=tail(names(sort(table(ONS_PostCodes$Region.Name[ID]))),1)
    d_practice$PrimaryCareTrust[kp]=tail(names(sort(table(ONS_PostCodes$Primary.Care.Trust.Name[ID]))),1)
    d_practice$OutputAreaClassification[kp]=tail(names(sort(table(ONS_PostCodes$Output.Area.Classification.Name[ID]))),1)
    }
  
  
}
save(d_practice,file=paste(data_folder,'/d_practice.Rdata',sep=''))

```


# Let us now get the vairables of interest for all patients, from 2016-2018

# let us now prepare the input data (PrepareData/CandidateFeature) where each table contains patient ID, and corresponding feature 

# Features 1-2: Sex (in OPCRD, 0 is female, and 1 is male) and Age
```{r}
rm(list=ls())
library(tidyverse)
data_load_folder='ServerData_13Oct2020'
data_save_folder='SexAndAge'
load('selectedPatients_13Oct2020.Rdata')
# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse'), .verbose = TRUE)%dopar%{
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/d_patient_part',kc,'.Rdata',sep='')) 
  feature_sex_age<-d_patient_part%>%
    mutate(sex=sex_coded)%>%
    mutate(age=2016-year_of_birth)%>%
    select(patid,practice_id,sex,age)
  save(feature_sex_age,file=paste('PrepareData/',data_save_folder,'/feature_sex_age_',kc,'.Rdata',sep=''))
}
```

# Feature 3: BMI
```{r}
rm(list=ls())
source('./ParallelCode.R')
library(tidyverse)
data_load_folder='ServerData_13Oct2020'
data_save_folder='BMI'
load('selectedPatients_13Oct2020.Rdata')
# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse'))%dopar%{
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_clinical_part',kc,'.Rdata',sep='')) 
  
  # get the latest weight value of the patient
  process_Weight<-f_clinical_part%>%
    group_by(patid)%>%
    filter((event_date)<ymd('2017/1/1'))%>%
    filter(code_id=='22A..')%>%
    arrange(desc(event_date),.by_group=TRUE)%>%
    filter(row_number()==1)%>%
    mutate(weight=numeric_1)
  # get the latest height value of the patient
  process_Height<-f_clinical_part%>%
    group_by(patid)%>%
    filter((event_date)<ymd('2017/1/1'))%>%
    filter(code_id=='229..')%>%
    arrange(desc(event_date),.by_group=TRUE)%>%
    filter(row_number()==1)%>%
    mutate(height=ifelse(numeric_1<5, numeric_1, numeric_1/100))
  
  feature_BMI <-process_Weight%>%
    inner_join(process_Height,by='patid')%>%
    mutate(BMI=weight/height^2)%>%
    select(patid,BMI, weight, height)
  
  save(feature_BMI,file=paste('PrepareData/',data_save_folder,'/feature_BMI_',kc,'.Rdata',sep=''))
}
```

# Feature 4: Ethnicity
```{r}
rm(list=ls())
source('./ParallelCode.R')
library(tidyverse)
data_load_folder='../ServerData_13Oct2020'
data_save_folder='Ethnicity'
load('../FinalData/selectedPatients_13Oct2020.Rdata')
Ethnicity <- read.csv('./ClinicalCodes/EthinicityNHS.csv')
# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse'), .verbose=TRUE)%dopar%{
# for (kc in c(1:num_files)){
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_clinical_part',kc,'.Rdata',sep='')) 
  
  # get the latest smoking status of the patient
  feature_Ethnicity<-f_clinical_part%>%
    group_by(patid)%>%
    filter((event_date)<ymd('2017/1/1'))%>%
    filter(code_id %in% Ethnicity$ReadCode)%>%
    arrange(desc(event_date),.by_group=TRUE)%>%
    filter(row_number()==1)%>%
    mutate(ethnicity=Ethnicity$Desc[which(Ethnicity$ReadCode==code_id)],
           ethnic_group=Ethnicity$Group[which(Ethnicity$ReadCode==code_id)])%>%
    select(patid,ethnicity, ethnic_group)
  
  save(feature_Ethnicity,file=paste('../PrepareData/',data_save_folder,'/feature_Ethnicity_',kc,'.Rdata',sep=''))
}
```

# Feature 5: Smoking Status
```{r}
rm(list=ls())
library(tidyverse)
library(lubridate)
data_load_folder='ServerData_13Oct2020'
data_save_folder='Smoking'
load('selectedPatients_13Oct2020.Rdata')
# load smoking codes
SmokingCodes=read.csv('./ClinicalCodes/SmokingReadcodes.csv')
smoking_never <-SmokingCodes%>%
  filter(Status=='N')
smoking_former <-SmokingCodes%>%
  filter(Status=='E')
smoking_current <-SmokingCodes%>%
  filter(Status=='S')

# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse', 'lubridate'))%dopar%{
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_clinical_part',kc,'.Rdata',sep='')) 
  
  # get the latest smoking status of the patient
  feature_Smoking<-f_clinical_part%>%
    group_by(patid)%>%
    filter((event_date)<ymd('2017/1/1'))%>%
    filter(code_id %in% SmokingCodes$Read.Code)%>%
    arrange(desc(event_date),.by_group=TRUE)%>%
    filter(row_number()==1)%>%
    mutate(smokingStatus=case_when(code_id %in% smoking_never$Read.Code ~ "never",
                                   code_id %in% smoking_former$Read.Code ~ "former",
                                   code_id %in% smoking_current$Read.Code ~ "current",
                                   TRUE ~ 'unknown'))%>%
    select(patid,smokingStatus)
  
  save(feature_Smoking,file=paste('PrepareData/',data_save_folder,'/feature_Smoking_',kc,'.Rdata',sep=''))
}
```

# Feature 6: Charlson Comorbidity Index
```{r}
rm(list=ls())
library(tidyverse)
library(lubridate)
data_load_folder='ServerData_13Oct2020'
data_save_folder='CharlsonCI'
load('selectedPatients_13Oct2020.Rdata')
# load smoking codes
CharlsonCodes=read.csv('./ClinicalCodes/12874_2019_753_MOESM1_ESM.csv')
# remove the term id and only keep the read code
CharlsonCodes$readcode=substr(CharlsonCodes$readcode,1,5)

# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse', 'lubridate'))%dopar%{
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_clinical_part',kc,'.Rdata',sep='')) 
  
  # get all the f_clinical until the baseline date
  f_clinical_part<-f_clinical_part%>%
    filter((event_date)<ymd('2017/1/1'))
  #let us now loop through each patient and get the CharlsonScore
  PatIDs=unique(f_clinical_part$patid)
  
  feature_CharlsonScore<-data.frame(patid=as.integer(),CharlsonScore=as.integer())
  total_patients=length(PatIDs)
  for (kp in c(1:total_patients)){
    print(paste('Processing Patient Number:',kp,', Total Patients:',total_patients,' in File Number:',kc))
    IP=which(f_clinical_part$patid==PatIDs[kp])
    
    CharlsonCodes_patient<-CharlsonCodes%>%
      filter(readcode  %in% f_clinical_part$code_id[IP])%>%
      group_by(cat)%>%
      filter(row_number()==1)
    
    newdata=data.frame(PatIDs[kp],sum(CharlsonCodes_patient$score))
    names(newdata)<-c("patid","CharlsonScore")
    feature_CharlsonScore<-rbind(feature_CharlsonScore,newdata)
    rm(CharlsonCodes_patient)
  }
    
  save(feature_CharlsonScore,file=paste('PrepareData/',data_save_folder,'/feature_CharlsonScore_',kc,'.Rdata',sep=''))
}
```

# Feature 9: % predicted PEF
```{r}
rm(list=ls())
library(tidyverse)
library(lubridate)
data_load_folder='ServerData_13Oct2020'
data_save_folder='PredictedPEF'
load('selectedPatients_13Oct2020.Rdata')
# load % predicted PEF Codes 
PredicedPEFCodes=read.csv('./ClinicalCodes/PeakFlowCodes.csv')

# let us get the PEF codes
PEF_60_80 <-PredicedPEFCodes%>%
  filter(Category=='60-80')
PEF_0_60 <-PredicedPEFCodes%>%
  filter(Category=='Less than 60')
PEF_80_100 <-PredicedPEFCodes%>%
  filter(Category=='More than 80')
PEF_Number <-PredicedPEFCodes%>%
  filter(Category=='Number')
PEF_Categories <-PredicedPEFCodes%>%
  filter(Category!='Number')

# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse', 'lubridate'))%dopar%{
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_clinical_part',kc,'.Rdata',sep='')) 
  
  # get the latest peak flow status of the patient
  feature_PEF<-f_clinical_part%>%
    group_by(patid)%>%
    filter((event_date)<ymd('2017/1/1'))%>%
    filter(code_id %in% PEF_Categories$Read.Code)%>%
    arrange(desc(event_date),.by_group=TRUE)%>%
    filter(row_number()==1)%>%
    mutate(PEFStatus=case_when(code_id %in% PEF_0_60$Read.Code ~ "less than 60",
                                   code_id %in% PEF_60_80$Read.Code ~ "60-80",
                                   code_id %in% PEF_80_100$Read.Code ~ "more than 80",
                                   TRUE ~ 'unknown'))
  
    
  save(feature_PEF,file=paste('PrepareData/',data_save_folder,'/feature_PEF_',kc,'.Rdata',sep=''))
}
```

# Feature 10: % Blood Eosinophil Count
```{r}
rm(list=ls())
library(tidyverse)
library(lubridate)
data_load_folder='ServerData_13Oct2020'
data_save_folder='EosinophilCount'
load('selectedPatients_13Oct2020.Rdata')
# load Blood Eosinophil Count Codes 
BloodEosinophilCodes=read.csv('./ClinicalCodes/EosinophilCount.csv')

# let us get the Blood Eosinophil Codes now
Eosinophil_number <-BloodEosinophilCodes%>%
  filter(Category=='number')
Eosinophil_level <-BloodEosinophilCodes%>%
  filter(Category %in% c('low','normal','high'))
Eosinophil_percentage <-BloodEosinophilCodes%>%
  filter(Category=='percentage')

# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse', 'lubridate'))%dopar%{
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_clinical_part',kc,'.Rdata',sep='')) 
    # get the latest Eosinophil number status of the patient
  feature_Eosinophil<-f_clinical_part%>%
    group_by(patid)%>%
    filter((event_date)<ymd('2017/1/1'))%>%
    filter(code_id %in% Eosinophil_number$Read.Code)%>%
    arrange(desc(event_date),.by_group=TRUE)%>%
    filter(row_number()==1)%>%
    mutate(EosinophilLevel=case_when(numeric_1<=0.4 ~ "normal",
                                     numeric_1>0.4 ~ "high",
                                     TRUE ~ 'unknown'))%>%
    select(patid,EosinophilLevel,event_date)

  
  save(feature_Eosinophil,file=paste('PrepareData/',data_save_folder,'/feature_Eosinophil_',kc,'.Rdata',sep=''))
}
```
#these features are processed in BTS_relatedFeatures.Rmd
#Feature 11: BTS Step
#Feature 12: Average Daily Dose of ICS
#Feature 13: Prescribed Daily Dose of ICS (last prescription at baseline)
#Feature 14: ICS medication ratio
#Feature 15: ICS Device Type
#Feature 16: Spacer Use with ICS mDPI
#Feature 17: and 23: OCS used in baseline
```{r}
rm(list=ls())
library(tidyverse)
library(lubridate)
data_load_folder='ServerData_13Oct2020'
data_save_folder='OralOCSUSe'
load('selectedPatients_13Oct2020.Rdata')
# get oral OCS codes now
asth_med_OCS_codes <- c("fe6..", "fe3..", "fe31.", "fe32.", "fe33.",
                        "fe36.", "fe37.", "fe3A.", "fe3B.", "fe3C.",
                        "fe3r.", "fe3s.", "fe3u.", "fe4..", "fe41.",
                        "fe42.", "fe43.", "fe44.", "fe45.", "fe4e.",
                        "fe4f.", "fe4g.", "fe4h.", "fe5..", "fe51.",
                        "fe52.", "fe53.", "fe5f.", "fe5m.", "fe5n.",
                        "fe5o.", "fe5p.", "fe61.", "fe62.", "fe64.",
                        "fe65.", "fe66.", "fe67.", "fe68.", "fe69.",
                        "fe6a.", "fe6c.", "fe6d.", "fe6e.", "fe6f.",
                        "fe6g.", "fe6h.", "fe6i.", "fe6j.", "fe6k.",
                        "fe6l.", "fe6m.", "fe6n.", "fe6o.", "fe6p.",
                        "fe6q.", "fe6r.", "fe6s.", "fe6t.", "fe6v.",
                        "fe6w.", "fe6z.", "fe7..", "fe71.", "fe72.",
                        "fe73.", "fe74.", "fe75.", "fe76.", "fe77.",
                        "fe78.", "fe79.", "fe7x.", "fe7y.", "fe7z.",
                        "x00yP", "x01Mh", "x01Na", "x01Nb", "fe11.",
                        "fe12.", "fe1x.", "fe1y.", "fe21.", "fe22.",
                        "fe23.", "fe24.", "fe25.", "fe26.", "x01MW")




# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse', 'lubridate'))%dopar%{
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_therapy_part',kc,'.Rdata',sep=''))
  ### Setup the OCS flag variable
  feature_OCS<-f_therapy_part%>%
    group_by(patid)%>%
    filter((event_date)<ymd('2017/1/1') & (event_date)>ymd('2015/12/31'))%>%
    filter(code_id %in% asth_med_OCS_codes)%>%
    arrange(desc(event_date),.by_group=TRUE)%>%
    mutate(numOCS=length(unique(event_date)))%>%
    filter(row_number()==1)%>%
    select(patid,numOCS)
   rm(f_therapy_part)
   save(feature_OCS,file=paste('PrepareData/',data_save_folder,'/feature_OCS_',kc,'.Rdata',sep=''))
}
```
# Feature 18: Prior Asthma Education
```{r}
rm(list=ls())
library(tidyverse)
library(lubridate)
data_load_folder='ServerData_13Oct2020'
data_save_folder='PriorAsthmaEducation'
load('selectedPatients_13Oct2020.Rdata')
PriorEducationCodes=read.csv('./ClinicalCodes/AsthmaEducationReadCodes.csv')

# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse', 'lubridate'))%dopar%{
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_clinical_part',kc,'.Rdata',sep=''))
 
  feature_priorAsthmaEducation<-f_clinical_part%>%
    group_by(patid)%>%
    filter((event_date)<ymd('2017/1/1'))%>%
    mutate(PriorEducation=if(any(code_id %in% PriorEducationCodes$ReadCode)) 1 else 0)%>%
    filter(row_number()==1)%>%
    select(patid,code_id,PriorEducation,event_date)
  
   rm(f_clinical_part)
   save(feature_priorAsthmaEducation,file=paste('PrepareData/',data_save_folder,'/feature_priorAsthmaEducation',kc,'.Rdata',sep=''))
}
```

#Feature 19: Number of Primary Care Consults
```{r}
rm(list=ls())
library(tidyverse)
library(lubridate)
data_load_folder='ServerData_13Oct2020'
data_save_folder='PrimaryCareConsults'
load('selectedPatients_13Oct2020.Rdata')

# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse', 'lubridate'))%dopar%{
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_clinical_part',kc,'.Rdata',sep=''))
  feature_primarycare<-f_clinical_part%>%
    group_by(patid)%>%
    filter((event_date)<ymd('2017/1/1') & (event_date)>ymd('2015/12/31'))%>%
    mutate(numPCS=length(unique(event_date)))%>%
    filter(row_number()==1)%>%
    select(patid,numPCS)
   rm(f_clinical_part)
   save(feature_primarycare,file=paste('PrepareData/',data_save_folder,'/feature_primarycare',kc,'.Rdata',sep=''))
}
```

# Feature 20: Number of Primary Care Consults for Asthma
```{r}
rm(list=ls())
library(tidyverse)
library(lubridate)
data_load_folder='ServerData_13Oct2020'
data_save_folder='PrimaryCareConsultsAsthma'
load('selectedPatients_13Oct2020.Rdata')
load('./DefiniteAsthmaCodes.Rdata')

# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse', 'lubridate'))%dopar%{
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_clinical_part',kc,'.Rdata',sep=''))
  feature_primarycareasthma<-f_clinical_part%>%
    group_by(patid)%>%
    filter((event_date)<ymd('2017/1/1') & (event_date)>ymd('2015/12/31'))%>%
    filter(code_id %in% definite_asthma_codes$readcode_new)%>%
    mutate(numPCS=length(unique(event_date)))%>%
    filter(row_number()==1)%>%
    select(patid,numPCS)
  
  
   rm(f_clinical_part)
   save(feature_primarycareasthma,file=paste('PrepareData/',data_save_folder,'/feature_primarycareasthma',kc,'.Rdata',sep=''))
}
```

#Features 21-27: Asthma outcome related features
```{r}
rm(list=ls())
source('./ParallelCode.R')
library(tidyverse)
library(lubridate)
library(mltools)
library(data.table)
data_load_folder='../ServerData_13Oct2020'
data_save_folder='CompoundFeatures'
load('../FinalData/selectedPatients_13Oct2020.Rdata')

# let us now get related codes for hospitalization, LRTI, asthma codes etc.
asthma_exacerbations_codes <- c("Xa1hD", "Xafdy", "Xafdz", "Xafdj","XE0YW","XM0s2","X101y","X1022","H333.","H3301","H3311","H33z0","H33z1") 
asthma_hospitalisations_codes <- c("663m.","663d.", "8H2P.")
resp_review_file = read.csv('./ClinicalCodes/cl_lower_resp_events.txt')
resp_review_codes=resp_review_file$read_code
antibiotic_codes = read.csv('./ClinicalCodes//dl_antibiotic.txt')
oral_ocs_codes <- c("fe6..", "fe3..", "fe31.", "fe32.", "fe33.",
                       "fe36.", "fe37.", "fe3A.", "fe3B.", "fe3C.",
                       "fe3r.", "fe3s.", "fe3u.", "fe4..", "fe41.",
                       "fe42.", "fe43.", "fe44.", "fe45.", "fe4e.",
                       "fe4f.", "fe4g.", "fe4h.", "fe5..", "fe51.",
                       "fe52.", "fe53.", "fe5f.", "fe5m.", "fe5n.",
                       "fe5o.", "fe5p.", "fe61.", "fe62.", "fe64.",
                       "fe65.", "fe66.", "fe67.", "fe68.", "fe69.",
                       "fe6a.", "fe6c.", "fe6d.", "fe6e.", "fe6f.",
                       "fe6g.", "fe6h.", "fe6i.", "fe6j.", "fe6k.",
                       "fe6l.", "fe6m.", "fe6n.", "fe6o.", "fe6p.",
                       "fe6q.", "fe6r.", "fe6s.", "fe6t.", "fe6v.",
                       "fe6w.", "fe6z.", "fe7..", "fe71.", "fe72.",
                       "fe73.", "fe74.", "fe75.", "fe76.", "fe77.",
                       "fe78.", "fe79.", "fe7x.", "fe7y.", "fe7z.",
                       "x00yP", "x01Mh", "x01Na", "x01Nb", "fe11.",
                       "fe12.", "fe1x.", "fe1y.", "fe21.", "fe22.",
                       "fe23.", "fe24.", "fe25.", "fe26.", "x01MW")

other_hospitalisation_codes = read.csv('./ClinicalCodes/HospitalisationCodes.csv')
# remove term id from these codes
other_hospitalisation_codes<-other_hospitalisation_codes %>%
  mutate(readcode_new=substr(read_code,1,5))
# also get the specific asthma codes
load('DefiniteAsthmaCodes.Rdata')

# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse', 'lubridate', 'mltools', 'data.table'))%dopar%{
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_clinical_part',kc,'.Rdata',sep='')) 
  load(paste(data_load_folder,'/f_therapy_part',kc,'.Rdata',sep=''))
  
  # first make sure that you are only dealing with data in the baseline year
  f_clinical_part<-f_clinical_part%>%
    group_by(patid)%>%
    filter((event_date)<ymd('2017/1/1') & (event_date)>ymd('2015/12/31'))
  f_therapy_part<-f_therapy_part%>%
    group_by(patid)%>%
    filter((event_date)<ymd('2017/1/1') & (event_date)>ymd('2015/12/31'))
  
  events_exac <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% asthma_exacerbations_codes)%>%
    mutate(eventType='exacerbation')
  events_hospitalisation <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% asthma_hospitalisations_codes)%>%
    mutate(eventType='hospitalisation')
  events_respReview <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% resp_review_codes)%>%
    mutate(eventType='respiratoryReview')
  events_OCS <- f_therapy_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% oral_ocs_codes)%>%
    mutate(eventType='OCS')
  events_OtherHospitalisation <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% other_hospitalisation_codes$readcode_new)%>%
    mutate(eventType='OtherHospitalisation')
  events_DefiniteAsthmaCodes <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% definite_asthma_codes$readcode_new)%>%
    mutate(eventType='DefiniteAsthma')
  events_Antibiotics <- f_therapy_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% antibiotic_codes$read_code)%>%
    mutate(eventType='Antibiotics')
  
   # combine all in one big dataframe
  events_all=rbind(events_exac,events_hospitalisation,events_OCS,events_respReview,events_OtherHospitalisation,events_DefiniteAsthmaCodes,events_Antibiotics)
  rm(events_OCS,events_hospitalisation,events_exac,events_respReview,events_OtherHospitalisation,events_DefiniteAsthmaCodes,events_Antibiotics)
  events_all <-events_all %>%
    arrange(patid,ymd(event_date))
 
 # get id of all patients
  patients_subset<-events_all%>%
    group_by(patid)%>%
    filter(row_number()==1)%>%
    select(patid)
  ### let us now get the features
  
  ## feature 21 (count of antibiotics)
  feature_countAntibiotics<-events_all%>%
    group_by(patid)%>%
    filter(eventType=='Antibiotics')%>%
    mutate(numAntibioticCourses=length(unique(event_date)))%>%
    filter(row_number()==1)%>%
    select(patid,numAntibioticCourses)
  
 ## for the remaining features, we should get a flag next to OCS, Antibiotics, and Other Hospitalization to confirm if they are present when there 
  
  #have flags to indicate whether to keep OCS, Antibiotics, and Hospitalization
  
  OCS_Keep_Vector=rep(-1,length(events_all$patid)) 
  events_all$OCS_Keep=OCS_Keep_Vector
   for (kpatient in c(1:length(patients_subset$patid))){
    #print(paste('Processing File Number:',kc,',patient number:',kpatient,',Total Patients:',chunk_size))
    selectedPatient_ID=patients_subset$patid[kpatient]
    I_P=which(events_all$patid==selectedPatient_ID & events_all$eventType=='respiratoryReview')
    I_OCS=which(events_all$patid==selectedPatient_ID & events_all$eventType=='OCS')
    #if no OCS and no respiratory review episodes
    if(length(I_P)==0 & length(I_OCS)==0){
      next
    }
    #if OCS episodes but no respiratory review
    if(length(I_P)==0 & length(I_OCS)>0){
      events_all$OCS_Keep[I_OCS]=1
      next
    }
    #if no OCS episodes but respiratory review
    if(length(I_OCS)==0 & length(I_P)>0){
      events_all$OCS_Keep[I_P]=5
      next
    }
    if(length(I_OCS)>0 & length(I_P)>0) # if both OCS and respiratory review episodes present
    {
      for (k_ocs in c(1:length(I_OCS))) # loop through each OCS episode
      {
        date_OCS=events_all$event_date[I_OCS[k_ocs]]
        date_respReview=events_all$event_date[I_P]
        
        # create two weeks around OCS date interval
        int = interval((ymd(date_OCS)-14),(ymd(date_OCS)+14))
        # check if any respiratory review in interval
        IC=which(ymd(date_respReview) %within% int)
        if(length(IC)>0)
        {
          events_all$OCS_Keep[I_OCS[k_ocs]]=3 # both present and within 2 weeks
        }
        else
        {
          events_all$OCS_Keep[I_OCS[k_ocs]]=2 # both present but not within 2 weeks
        }
      }
    }
    
  }
  
  Hosp_Keep_Vector=rep(-1,length(events_all$patid)) 
  events_all$Hosp_Keep=Hosp_Keep_Vector
   for (kpatient in c(1:length(patients_subset$patid))){
    #print(paste('Processing File Number:',kc,',patient number:',kpatient,',Total Patients:',chunk_size))
    selectedPatient_ID=patients_subset$patid[kpatient]
    I_OH=which(events_all$patid==selectedPatient_ID & events_all$eventType=='OtherHospitalisation')
    I_DA=which(events_all$patid==selectedPatient_ID & events_all$eventType=='DefiniteAsthma')
  
      #if no definite asthma and no other hospitalisation code
    if(length(I_OH)==0 & length(I_DA)==0){
      next
    }
    #if definite asthma but no other hospitalisation code
    if(length(I_OH)==0 & length(I_DA)>0){
      events_all$Hosp_Keep[I_DA]=1
      next
    }
    #if no definite asthma but other hospitalisation code present
    if(length(I_DA)==0 & length(I_OH)>0){
      events_all$Hosp_Keep[I_OH]=2
      next
    }
    if(length(I_DA)>0 & length(I_OH)>0) # if both definite asthma and other hospitalisation present
    {
      dates_OH=events_all$event_date[I_OH]
      dates_DA=events_all$event_date[I_DA]
      IS=which(dates_OH %in% dates_DA) # only get those dates which have definite asthma
      events_all$Hosp_Keep[I_OH[IS]]=3
    }
  }
    
  Antibiotics_Keep_Vector=rep(-1,length(events_all$patid)) 
  events_all$Antibiotics_Keep=Antibiotics_Keep_Vector
   for (kpatient in c(1:length(patients_subset$patid))){
    #print(paste('Processing File Number:',kc,',patient number:',kpatient,',Total Patients:',chunk_size))
    selectedPatient_ID=patients_subset$patid[kpatient]
    I_P=which(events_all$patid==selectedPatient_ID & events_all$eventType=='respiratoryReview')
    I_AB=which(events_all$patid==selectedPatient_ID & events_all$eventType=='Antibiotics')
    #if no Antibiotics and no respiratory review episodes
    if(length(I_P)==0 & length(I_AB)==0){
      next
    }
    #if Antibiotics episodes but no respiratory review
    if(length(I_P)==0 & length(I_AB)>0){
      events_all$Antibiotics_Keep[I_AB]=1
      next
    }
    #if no Antibiotics episodes but respiratory review
    if(length(I_AB)==0 & length(I_P)>0){
      events_all$Antibiotics_Keep[I_P]=5
      next
    }
    if(length(I_AB)>0 & length(I_P)>0) # if both Antibiotics and respiratory review episodes present
    {
      for (k_ab in c(1:length(I_AB))) # loop through each Antibiotics episode
      {
        date_Antibiotics=events_all$event_date[I_AB[k_ab]]
        date_respReview=events_all$event_date[I_P]
        
        # create two weeks around Antibiotics date interval
        int = interval((ymd(date_Antibiotics)-14),(ymd(date_Antibiotics)+14))
        # check if any respiratory review in interval
        IC=which(ymd(date_respReview) %within% int)
        if(length(IC)>0)
        {
          events_all$Antibiotics_Keep[I_AB[k_ab]]=3 # both present and within 2 weeks
        }
        else
        {
          events_all$Antibiotics_Keep[I_AB[k_ab]]=2 # both present but not within 2 weeks
        }
      }
    }
    
  }
  features_compound=events_all
  rm(events_all)
  
  # let us now extract the relevant features from the features_compound now
 
   # Feature 21 (number of Antibiotics courses in the baseline)
  feature_numAntibiotics<-features_compound%>%
    filter(  eventType=='Antibiotics' )%>%
    group_by(patid)%>%
    mutate(numAntibioticsEvents=length(unique(event_date)))%>%
    filter(row_number()==1)%>%
    select(patid,numAntibioticsEvents)%>%
    arrange(patid)
  
   #Feature 22 (number of respiratory events)
  feature_acuteRespEvents<-features_compound%>%
    filter((OCS_Keep==3 & eventType=='OCS')| (Hosp_Keep==3 & eventType=='OtherHospitalisation')| (Antibiotics_Keep==3  & eventType=='Antibiotics')| eventType=='exacerbation' | eventType=='hospitalisation')%>%
    group_by(patid)%>%
    mutate(numAcuteRespEvents=length(unique(event_date)))%>%
    filter(row_number()==1)%>%
    select(patid,numAcuteRespEvents)
  
  # Feature 23 (number of OCS courses in the baseline)
  feature_numOCS<-features_compound%>%
    filter(  eventType=='OCS' )%>%
    group_by(patid)%>%
    mutate(numOCSEvents=length(unique(event_date)))%>%
    filter(row_number()==1)%>%
    select(patid,numOCSEvents)%>%
    arrange(patid)
  
  # Feature 24 (number of OCS courses with LRTI in the baseline)
  feature_numOCSwithLRTI<-features_compound%>%
    filter (OCS_Keep==3 & eventType=='OCS' )%>%
    group_by(patid)%>%
    mutate(numOCSwithLRTI=length(unique(event_date)))%>%
    filter(row_number()==1)%>%
    select(patid,numOCSwithLRTI)%>%
    arrange(patid)
  
  
 
  # Feature 25 (number of Antibiotic courses with LRTI in the baseline)
  feature_numAntibioticswithLRTI<-features_compound%>%
    filter (Antibiotics_Keep==3 & eventType=='Antibiotics' )%>%
    group_by(patid)%>%
    mutate(numAntibioticswithLRTI=length(unique(event_date)))%>%
    filter(row_number()==1)%>%
    select(patid,numAntibioticswithLRTI)%>%
    arrange(patid)
  
  #Feature 26 (number of asthma-related ED or hospital attendance/admission)
  feature_numHospitals<-features_compound%>%
    filter((Hosp_Keep==3 & eventType=='OtherHospitalisation') | eventType=='hospitalisation')%>%
    group_by(patid)%>%
    mutate(numHospEvents=length(unique(event_date)))%>%
    filter(row_number()==1)%>%
    select(patid,numHospEvents)  
  
  #Feature 27 (number of asthma attacks)
  feature_asthmaAttacks<-features_compound%>%
    filter((OCS_Keep==3 & eventType=='OCS')| (Hosp_Keep==3 & eventType=='OtherHospitalisation') | eventType=='exacerbation' | eventType=='hospitalisation')%>%
    group_by(patid)%>%
    mutate(numAsthmaAttacks=length(unique(event_date)))%>%
    filter(row_number()==1)%>%
    select(patid,numAsthmaAttacks) 
  
  #Feature 27_extended (month of asthma attacks)
  feature_asthmaAttacks_month <- features_compound%>%
    filter((OCS_Keep==3 & eventType=='OCS')| (Hosp_Keep==3 & eventType=='OtherHospitalisation') | eventType=='exacerbation' | eventType=='hospitalisation') %>% 
    mutate(month=as.factor(month(ymd(event_date)))) %>% 
    select(patid,month)
  feature_asthmaAttacks_month <- as_tibble(one_hot(as.data.table(feature_asthmaAttacks_month)))
  
    #Feature 21
  save(feature_numAntibiotics,file=paste('PrepareData/',data_save_folder,'/feature_numAntibiotics_',kc,'.Rdata',sep=''))
    #Feature 22
  save(feature_acuteRespEvents,file=paste('PrepareData/',data_save_folder,'/feature_acuteRespEvents_',kc,'.Rdata',sep=''))
    #Feature 23
  save(feature_numOCS,file=paste('PrepareData/',data_save_folder,'/feature_numOCS_',kc,'.Rdata',sep=''))
    #Feature 24
  save(feature_numOCSwithLRTI,file=paste('PrepareData/',data_save_folder,'/feature_numOCSwithLRTI_',kc,'.Rdata',sep=''))
    #Feature 25
  save(feature_numAntibioticswithLRTI,file=paste('PrepareData/',data_save_folder,'/feature_numAntibioticswithLRTI_',kc,'.Rdata',sep=''))
    #Feature 26
  save(feature_numHospitals,file=paste('PrepareData/',data_save_folder,'/feature_numHospitals_',kc,'.Rdata',sep=''))
  #Feature 27
  save(feature_asthmaAttacks,file=paste('PrepareData/',data_save_folder,'/feature_asthmaAttacks_',kc,'.Rdata',sep=''))
  #Feature 27_extended
save(feature_asthmaAttacks_month,file=paste('PrepareData/',data_save_folder,'/feature_asthmaAttacksMonth_',kc,'.Rdata',sep=''))
}
```

# Feature : Comorbidity
```{r}
rm(list=ls())
source('./ParallelCode.R')
library(tidyverse)
data_load_folder='../ServerData_13Oct2020'
data_save_folder='Comorbidity'
load('../FinalData/selectedPatients_13Oct2020.Rdata')
comorbid_code = read.csv('./ClinicalCodes/comorbid.csv')
# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse'))%dopar%{
# for (kc in c(1:1)){
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_clinical_part',kc,'.Rdata',sep='')) 
  
  # get comorbidity data
  feature_comorbid<-f_clinical_part%>%
    filter((event_date)<ymd('2017/1/1'))%>%
    # filter(code_id %in% comorbid_code$ReadCodes)%>%
    mutate(comorbid_rhinitis = ifelse (code_id %in% comorbid_code$ReadCodes[which(comorbid_code$Comorbid=='Rhinitis')], 1, 0),
           comorbid_cardiovascular = ifelse (code_id %in% comorbid_code$ReadCodes[which(comorbid_code$Comorbid=='Cardiovascular')],1,0),
           comorbid_heartfailure = ifelse (code_id %in% comorbid_code$ReadCodes[which(comorbid_code$Comorbid=='Heart Failure')],1,0),
           comorbid_psoriasis = ifelse (code_id %in% comorbid_code$ReadCodes[which(comorbid_code$Comorbid=='Psoriasis')],1,0),
           comorbid_anaphylaxis = ifelse (code_id %in% comorbid_code$ReadCodes[which(comorbid_code$Comorbid=='Anaphylaxis')],1,0),
           comorbid_diabetes = ifelse (code_id %in% comorbid_code$ReadCodes[which(comorbid_code$Comorbid=='Diabetes')],1,0),
           comorbid_ihd = ifelse (code_id %in% comorbid_code$ReadCodes[which(comorbid_code$Comorbid=='Ischaemic Heart Disease')],1,0),
           comorbid_anxiety = ifelse (code_id %in% comorbid_code$ReadCodes[which(comorbid_code$Comorbid=='Anxiety')],1,0),
           comorbid_eczema = ifelse (code_id %in% comorbid_code$ReadCodes[which(comorbid_code$Comorbid=='Eczema')],1,0),
           comorbid_nasalpolyps = ifelse (code_id %in% comorbid_code$ReadCodes[which(comorbid_code$Comorbid=='Nasal Polyps')],1,0))
  
  feature_comorbid <- feature_comorbid %>% 
  group_by(patid) %>% 
  summarise(count_rhinitis=sum(comorbid_rhinitis),
            count_cardiovascular=sum(comorbid_cardiovascular),
            count_heartfailure=sum(comorbid_heartfailure),
            count_psoriasis=sum(comorbid_psoriasis),
            count_anaphylaxis=sum(comorbid_anaphylaxis),
            count_diabetes=sum(comorbid_diabetes),
            count_ihd=sum(comorbid_ihd),
            count_anxiety=sum(comorbid_anxiety),
            count_eczema=sum(comorbid_eczema),
            count_nasalpolyps=sum(comorbid_nasalpolyps))

  
  save(feature_comorbid,file=paste('../PrepareData/',data_save_folder,'/feature_comorbid_',kc,'.Rdata',sep=''))


  
}
```

# Feature : Comedication
```{r}
rm(list=ls())
source('./ParallelCode.R')
library(tidyverse)
data_load_folder='../ServerData_13Oct2020'
data_save_folder='Comedication'
load('../FinalData/selectedPatients_13Oct2020.Rdata')
comedication_code = read.csv('./ClinicalCodes/comedication.csv')
# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse'))%dopar%{
# for (kc in c(1:1)){
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_clinical_part',kc,'.Rdata',sep='')) 
  
  # get the latest weight value of the patient
  feature_comedication<-f_clinical_part%>%
    filter((event_date)<ymd('2017/1/1'))%>%
    # filter(code_id %in% comedication_code$Read.Codes)%>%
    mutate(comedication_paracetamol = ifelse (code_id %in% comedication_code$Read.Codes[which(comedication_code$Comedication=='Paracetamol')], 1, 0),
           comedication_nsaids = ifelse (code_id %in% comedication_code$Read.Codes[which(comedication_code$Comedication=='nsaids')],1,0),
           comedication_betablocker = ifelse (code_id %in% comedication_code$Read.Codes[which(comedication_code$Comedication=='beta blocker')],1,0))
  
  feature_comedication <- feature_comedication %>% 
  group_by(patid) %>% 
  summarise(count_paracetamol=sum(comedication_paracetamol),
            count_nsaids=sum(comedication_nsaids),
            count_betablocker=sum(comedication_betablocker))

  
  save(feature_comedication,file=paste('../PrepareData/',data_save_folder,'/feature_comedication_',kc,'.Rdata',sep=''))


  
}
```


# Outcome Coding

# outcome 1 : exacerbation attack in 3 months (1st January 2017-31st March 2017)
```{r}
rm(list=ls())
library(tidyverse)
library(lubridate)
library(tictoc)
tic()
data_load_folder='ServerData_13Oct2020'
data_save_folder='Outcome_3months'
load('selectedPatients_13Oct2020.Rdata')

# let us now get related codes for hospitalization, LRTI, asthma codes etc.
asthma_exacerbations_codes <- c("Xa1hD", "Xafdy", "Xafdz", "Xafdj","XE0YW","XM0s2","X101y","X1022","H333.","H3301","H3311","H33z0","H33z1") 
asthma_hospitalisations_codes <- c("663m.","663d.", "8H2P.")
resp_review_file = read.csv('./ClinicalCodes/cl_lower_resp_events.txt')
resp_review_codes=resp_review_file$read_code
oral_ocs_codes <- c("fe6..", "fe3..", "fe31.", "fe32.", "fe33.",
                       "fe36.", "fe37.", "fe3A.", "fe3B.", "fe3C.",
                       "fe3r.", "fe3s.", "fe3u.", "fe4..", "fe41.",
                       "fe42.", "fe43.", "fe44.", "fe45.", "fe4e.",
                       "fe4f.", "fe4g.", "fe4h.", "fe5..", "fe51.",
                       "fe52.", "fe53.", "fe5f.", "fe5m.", "fe5n.",
                       "fe5o.", "fe5p.", "fe61.", "fe62.", "fe64.",
                       "fe65.", "fe66.", "fe67.", "fe68.", "fe69.",
                       "fe6a.", "fe6c.", "fe6d.", "fe6e.", "fe6f.",
                       "fe6g.", "fe6h.", "fe6i.", "fe6j.", "fe6k.",
                       "fe6l.", "fe6m.", "fe6n.", "fe6o.", "fe6p.",
                       "fe6q.", "fe6r.", "fe6s.", "fe6t.", "fe6v.",
                       "fe6w.", "fe6z.", "fe7..", "fe71.", "fe72.",
                       "fe73.", "fe74.", "fe75.", "fe76.", "fe77.",
                       "fe78.", "fe79.", "fe7x.", "fe7y.", "fe7z.",
                       "x00yP", "x01Mh", "x01Na", "x01Nb", "fe11.",
                       "fe12.", "fe1x.", "fe1y.", "fe21.", "fe22.",
                       "fe23.", "fe24.", "fe25.", "fe26.", "x01MW")

other_hospitalisation_codes = read.csv('./ClinicalCodes/HospitalisationCodes.csv')
# remove term id from these codes
other_hospitalisation_codes<-other_hospitalisation_codes %>%
  mutate(readcode_new=substr(read_code,1,5))
# also get the specific asthma codes
load('DefiniteAsthmaCodes.Rdata')

# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse', 'lubridate'))%dopar%{
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_clinical_part',kc,'.Rdata',sep='')) 
  load(paste(data_load_folder,'/f_therapy_part',kc,'.Rdata',sep=''))
  
  # first make sure that you are only dealing with data in the appropriate outcome period
  f_clinical_part<-f_clinical_part%>%
    group_by(patid)%>%
    filter((event_date)<=ymd('2017/3/31') & (event_date)>=ymd('2017/1/1'))
  f_therapy_part<-f_therapy_part%>%
    group_by(patid)%>%
    filter((event_date)<=ymd('2017/3/31') & (event_date)>=ymd('2017/1/1'))
  
  events_exac <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% asthma_exacerbations_codes)%>%
    mutate(eventType='exacerbation')
  events_hospitalisation <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% asthma_hospitalisations_codes)%>%
    mutate(eventType='hospitalisation')
  events_respReview <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% resp_review_codes)%>%
    mutate(eventType='respiratoryReview')
  events_OCS <- f_therapy_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% oral_ocs_codes)%>%
    mutate(eventType='OCS')
  events_OtherHospitalisation <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% other_hospitalisation_codes$readcode_new)%>%
    mutate(eventType='OtherHospitalisation')
  events_DefiniteAsthmaCodes <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% definite_asthma_codes$readcode_new)%>%
    mutate(eventType='DefiniteAsthma')
  
   # combine all in one big dataframe
  events_all=rbind(events_exac,events_hospitalisation,events_OCS,events_respReview,events_OtherHospitalisation,events_DefiniteAsthmaCodes)
  rm(events_OCS,events_hospitalisation,events_exac,events_respReview,events_OtherHospitalisation,events_DefiniteAsthmaCodes)
  events_all <-events_all %>%
    arrange(patid,ymd(event_date))
 
 # get id of all patients
  patients_subset<-events_all%>%
    group_by(patid)%>%
    filter(row_number()==1)%>%
    select(patid)
  
  ### Let's start by getting a flag next to OCS,  and Other Hospitalization to confirm if they are present when there was a respiratory review
  
  OCS_Keep_Vector=rep(-1,length(events_all$patid)) 
  events_all$OCS_Keep=OCS_Keep_Vector
   for (kpatient in c(1:length(patients_subset$patid))){
    #print(paste('Processing File Number:',kc,',patient number:',kpatient,',Total Patients:',chunk_size))
    selectedPatient_ID=patients_subset$patid[kpatient]
    I_P=which(events_all$patid==selectedPatient_ID & events_all$eventType=='respiratoryReview')
    I_OCS=which(events_all$patid==selectedPatient_ID & events_all$eventType=='OCS')
    #if no OCS and no respiratory review episodes
    if(length(I_P)==0 & length(I_OCS)==0){
      next
    }
    #if OCS episodes but no respiratory review
    if(length(I_P)==0 & length(I_OCS)>0){
      events_all$OCS_Keep[I_OCS]=1
      next
    }
    #if no OCS episodes but respiratory review
    if(length(I_OCS)==0 & length(I_P)>0){
      events_all$OCS_Keep[I_P]=5
      next
    }
    if(length(I_OCS)>0 & length(I_P)>0) # if both OCS and respiratory review episodes present
    {
      for (k_ocs in c(1:length(I_OCS))) # loop through each OCS episode
      {
        date_OCS=events_all$event_date[I_OCS[k_ocs]]
        date_respReview=events_all$event_date[I_P]
        
        # create two weeks around OCS date interval
        int = interval((ymd(date_OCS)-14),(ymd(date_OCS)+14))
        # check if any respiratory review in interval
        IC=which(ymd(date_respReview) %within% int)
        if(length(IC)>0)
        {
          events_all$OCS_Keep[I_OCS[k_ocs]]=3 # both present and within 2 weeks
        }
        else
        {
          events_all$OCS_Keep[I_OCS[k_ocs]]=2 # both present but not within 2 weeks
        }
      }
    }
    
  }
  
  Hosp_Keep_Vector=rep(-1,length(events_all$patid)) 
  events_all$Hosp_Keep=Hosp_Keep_Vector
   for (kpatient in c(1:length(patients_subset$patid))){
    #print(paste('Processing File Number:',kc,',patient number:',kpatient,',Total Patients:',chunk_size))
    selectedPatient_ID=patients_subset$patid[kpatient]
    I_OH=which(events_all$patid==selectedPatient_ID & events_all$eventType=='OtherHospitalisation')
    I_DA=which(events_all$patid==selectedPatient_ID & events_all$eventType=='DefiniteAsthma')
  
      #if no definite asthma and no other hospitalisation code
    if(length(I_OH)==0 & length(I_DA)==0){
      next
    }
    #if definite asthma but no other hospitalisation code
    if(length(I_OH)==0 & length(I_DA)>0){
      events_all$Hosp_Keep[I_DA]=1
      next
    }
    #if no definite asthma but other hospitalisation code present
    if(length(I_DA)==0 & length(I_OH)>0){
      events_all$Hosp_Keep[I_OH]=2
      next
    }
    if(length(I_DA)>0 & length(I_OH)>0) # if both definite asthma and other hospitalisation present
    {
      dates_OH=events_all$event_date[I_OH]
      dates_DA=events_all$event_date[I_DA]
      IS=which(dates_OH %in% dates_DA) # only get those dates which have definite asthma
      events_all$Hosp_Keep[I_OH[IS]]=3
    }
  }
    

  # let us now extract the outcome from events_all
 
 
  #Asthma Attacks (in 3 months) 
  asthmaAttacks_3months<-events_all%>%
    group_by(patid)%>%
    mutate(outcome_3months=if(any((OCS_Keep==3 & eventType=='OCS')| (Hosp_Keep==3 & eventType=='OtherHospitalisation') | eventType=='exacerbation' | eventType=='hospitalisation'))1 else 0)%>%
    filter(row_number()==1)%>%
    select(patid,outcome_3months) 
  
  save(asthmaAttacks_3months,file=paste('PrepareData/',data_save_folder,'/asthmaAttacks_3months_',kc,'.Rdata',sep=''))
}
toc()
```

# outcome 2 : exacerbation attack in 6 months (01st April 2017 -30th June 2017)
```{r}
rm(list=ls())
library(tidyverse)
library(lubridate)
data_load_folder='ServerData_13Oct2020'
data_save_folder='Outcome_6months'
load('selectedPatients_13Oct2020.Rdata')

# let us now get related codes for hospitalization, LRTI, asthma codes etc.
asthma_exacerbations_codes <- c("Xa1hD", "Xafdy", "Xafdz", "Xafdj","XE0YW","XM0s2","X101y","X1022","H333.","H3301","H3311","H33z0","H33z1") 
asthma_hospitalisations_codes <- c("663m.","663d.", "8H2P.")
resp_review_file = read.csv('./ClinicalCodes/cl_lower_resp_events.txt')
resp_review_codes=resp_review_file$read_code
oral_ocs_codes <- c("fe6..", "fe3..", "fe31.", "fe32.", "fe33.",
                       "fe36.", "fe37.", "fe3A.", "fe3B.", "fe3C.",
                       "fe3r.", "fe3s.", "fe3u.", "fe4..", "fe41.",
                       "fe42.", "fe43.", "fe44.", "fe45.", "fe4e.",
                       "fe4f.", "fe4g.", "fe4h.", "fe5..", "fe51.",
                       "fe52.", "fe53.", "fe5f.", "fe5m.", "fe5n.",
                       "fe5o.", "fe5p.", "fe61.", "fe62.", "fe64.",
                       "fe65.", "fe66.", "fe67.", "fe68.", "fe69.",
                       "fe6a.", "fe6c.", "fe6d.", "fe6e.", "fe6f.",
                       "fe6g.", "fe6h.", "fe6i.", "fe6j.", "fe6k.",
                       "fe6l.", "fe6m.", "fe6n.", "fe6o.", "fe6p.",
                       "fe6q.", "fe6r.", "fe6s.", "fe6t.", "fe6v.",
                       "fe6w.", "fe6z.", "fe7..", "fe71.", "fe72.",
                       "fe73.", "fe74.", "fe75.", "fe76.", "fe77.",
                       "fe78.", "fe79.", "fe7x.", "fe7y.", "fe7z.",
                       "x00yP", "x01Mh", "x01Na", "x01Nb", "fe11.",
                       "fe12.", "fe1x.", "fe1y.", "fe21.", "fe22.",
                       "fe23.", "fe24.", "fe25.", "fe26.", "x01MW")

other_hospitalisation_codes = read.csv('./ClinicalCodes/HospitalisationCodes.csv')
# remove term id from these codes
other_hospitalisation_codes<-other_hospitalisation_codes %>%
  mutate(readcode_new=substr(read_code,1,5))
# also get the specific asthma codes
load('DefiniteAsthmaCodes.Rdata')

# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse', 'lubridate'))%dopar%{
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_clinical_part',kc,'.Rdata',sep='')) 
  load(paste(data_load_folder,'/f_therapy_part',kc,'.Rdata',sep=''))
  
  # first make sure that you are only dealing with data in the appropriate outcome period
  f_clinical_part<-f_clinical_part%>%
    group_by(patid)%>%
    filter((event_date)<=ymd('2017/6/30') & (event_date)>=ymd('2017/4/1'))
  f_therapy_part<-f_therapy_part%>%
    group_by(patid)%>%
    filter((event_date)<=ymd('2017/6/30') & (event_date)>=ymd('2017/4/1'))
  
  events_exac <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% asthma_exacerbations_codes)%>%
    mutate(eventType='exacerbation')
  events_hospitalisation <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% asthma_hospitalisations_codes)%>%
    mutate(eventType='hospitalisation')
  events_respReview <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% resp_review_codes)%>%
    mutate(eventType='respiratoryReview')
  events_OCS <- f_therapy_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% oral_ocs_codes)%>%
    mutate(eventType='OCS')
  events_OtherHospitalisation <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% other_hospitalisation_codes$readcode_new)%>%
    mutate(eventType='OtherHospitalisation')
  events_DefiniteAsthmaCodes <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% definite_asthma_codes$readcode_new)%>%
    mutate(eventType='DefiniteAsthma')
  
   # combine all in one big dataframe
  events_all=rbind(events_exac,events_hospitalisation,events_OCS,events_respReview,events_OtherHospitalisation,events_DefiniteAsthmaCodes)
  rm(events_OCS,events_hospitalisation,events_exac,events_respReview,events_OtherHospitalisation,events_DefiniteAsthmaCodes)
  events_all <-events_all %>%
    arrange(patid,ymd(event_date))
 
 # get id of all patients
  patients_subset<-events_all%>%
    group_by(patid)%>%
    filter(row_number()==1)%>%
    select(patid)
  
  ### Let's start by getting a flag next to OCS,  and Other Hospitalization to confirm if they are present when there was a respiratory review
  
  OCS_Keep_Vector=rep(-1,length(events_all$patid)) 
  events_all$OCS_Keep=OCS_Keep_Vector
   for (kpatient in c(1:length(patients_subset$patid))){
    #print(paste('Processing File Number:',kc,',patient number:',kpatient,',Total Patients:',chunk_size))
    selectedPatient_ID=patients_subset$patid[kpatient]
    I_P=which(events_all$patid==selectedPatient_ID & events_all$eventType=='respiratoryReview')
    I_OCS=which(events_all$patid==selectedPatient_ID & events_all$eventType=='OCS')
    #if no OCS and no respiratory review episodes
    if(length(I_P)==0 & length(I_OCS)==0){
      next
    }
    #if OCS episodes but no respiratory review
    if(length(I_P)==0 & length(I_OCS)>0){
      events_all$OCS_Keep[I_OCS]=1
      next
    }
    #if no OCS episodes but respiratory review
    if(length(I_OCS)==0 & length(I_P)>0){
      events_all$OCS_Keep[I_P]=5
      next
    }
    if(length(I_OCS)>0 & length(I_P)>0) # if both OCS and respiratory review episodes present
    {
      for (k_ocs in c(1:length(I_OCS))) # loop through each OCS episode
      {
        date_OCS=events_all$event_date[I_OCS[k_ocs]]
        date_respReview=events_all$event_date[I_P]
        
        # create two weeks around OCS date interval
        int = interval((ymd(date_OCS)-14),(ymd(date_OCS)+14))
        # check if any respiratory review in interval
        IC=which(ymd(date_respReview) %within% int)
        if(length(IC)>0)
        {
          events_all$OCS_Keep[I_OCS[k_ocs]]=3 # both present and within 2 weeks
        }
        else
        {
          events_all$OCS_Keep[I_OCS[k_ocs]]=2 # both present but not within 2 weeks
        }
      }
    }
    
  }
  
  Hosp_Keep_Vector=rep(-1,length(events_all$patid)) 
  events_all$Hosp_Keep=Hosp_Keep_Vector
   for (kpatient in c(1:length(patients_subset$patid))){
    #print(paste('Processing File Number:',kc,',patient number:',kpatient,',Total Patients:',chunk_size))
    selectedPatient_ID=patients_subset$patid[kpatient]
    I_OH=which(events_all$patid==selectedPatient_ID & events_all$eventType=='OtherHospitalisation')
    I_DA=which(events_all$patid==selectedPatient_ID & events_all$eventType=='DefiniteAsthma')
  
      #if no definite asthma and no other hospitalisation code
    if(length(I_OH)==0 & length(I_DA)==0){
      next
    }
    #if definite asthma but no other hospitalisation code
    if(length(I_OH)==0 & length(I_DA)>0){
      events_all$Hosp_Keep[I_DA]=1
      next
    }
    #if no definite asthma but other hospitalisation code present
    if(length(I_DA)==0 & length(I_OH)>0){
      events_all$Hosp_Keep[I_OH]=2
      next
    }
    if(length(I_DA)>0 & length(I_OH)>0) # if both definite asthma and other hospitalisation present
    {
      dates_OH=events_all$event_date[I_OH]
      dates_DA=events_all$event_date[I_DA]
      IS=which(dates_OH %in% dates_DA) # only get those dates which have definite asthma
      events_all$Hosp_Keep[I_OH[IS]]=3
    }
  }
    

  # let us now extract the outcome from events_all
 
 
  #Asthma Attacks (in 6 months) 
  asthmaAttacks_6months<-events_all%>%
    group_by(patid)%>%
    mutate(outcome_6months=if(any((OCS_Keep==3 & eventType=='OCS')| (Hosp_Keep==3 & eventType=='OtherHospitalisation') | eventType=='exacerbation' | eventType=='hospitalisation'))1 else 0)%>%
    filter(row_number()==1)%>%
    select(patid,outcome_6months) 
  
  save(asthmaAttacks_6months,file=paste('PrepareData/',data_save_folder,'/asthmaAttacks_6months_',kc,'.Rdata',sep=''))
}
```

# outcome 3 : exacerbation attack in 9 months (1st July 2017- 30th Sep 2017)
```{r}
rm(list=ls())
library(tidyverse)
library(lubridate)
data_load_folder='ServerData_13Oct2020'
data_save_folder='Outcome_9months'
load('selectedPatients_13Oct2020.Rdata')

# let us now get related codes for hospitalization, LRTI, asthma codes etc.
asthma_exacerbations_codes <- c("Xa1hD", "Xafdy", "Xafdz", "Xafdj","XE0YW","XM0s2","X101y","X1022","H333.","H3301","H3311","H33z0","H33z1") 
asthma_hospitalisations_codes <- c("663m.","663d.", "8H2P.")
resp_review_file = read.csv('./ClinicalCodes/cl_lower_resp_events.txt')
resp_review_codes=resp_review_file$read_code
oral_ocs_codes <- c("fe6..", "fe3..", "fe31.", "fe32.", "fe33.",
                       "fe36.", "fe37.", "fe3A.", "fe3B.", "fe3C.",
                       "fe3r.", "fe3s.", "fe3u.", "fe4..", "fe41.",
                       "fe42.", "fe43.", "fe44.", "fe45.", "fe4e.",
                       "fe4f.", "fe4g.", "fe4h.", "fe5..", "fe51.",
                       "fe52.", "fe53.", "fe5f.", "fe5m.", "fe5n.",
                       "fe5o.", "fe5p.", "fe61.", "fe62.", "fe64.",
                       "fe65.", "fe66.", "fe67.", "fe68.", "fe69.",
                       "fe6a.", "fe6c.", "fe6d.", "fe6e.", "fe6f.",
                       "fe6g.", "fe6h.", "fe6i.", "fe6j.", "fe6k.",
                       "fe6l.", "fe6m.", "fe6n.", "fe6o.", "fe6p.",
                       "fe6q.", "fe6r.", "fe6s.", "fe6t.", "fe6v.",
                       "fe6w.", "fe6z.", "fe7..", "fe71.", "fe72.",
                       "fe73.", "fe74.", "fe75.", "fe76.", "fe77.",
                       "fe78.", "fe79.", "fe7x.", "fe7y.", "fe7z.",
                       "x00yP", "x01Mh", "x01Na", "x01Nb", "fe11.",
                       "fe12.", "fe1x.", "fe1y.", "fe21.", "fe22.",
                       "fe23.", "fe24.", "fe25.", "fe26.", "x01MW")

other_hospitalisation_codes = read.csv('./ClinicalCodes/HospitalisationCodes.csv')
# remove term id from these codes
other_hospitalisation_codes<-other_hospitalisation_codes %>%
  mutate(readcode_new=substr(read_code,1,5))
# also get the specific asthma codes
load('DefiniteAsthmaCodes.Rdata')

# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse', 'lubridate'))%dopar%{
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_clinical_part',kc,'.Rdata',sep='')) 
  load(paste(data_load_folder,'/f_therapy_part',kc,'.Rdata',sep=''))
  
  # first make sure that you are only dealing with data in the appropriate outcome period
  f_clinical_part<-f_clinical_part%>%
    group_by(patid)%>%
    filter((event_date)<=ymd('2017/9/30') & (event_date)>=ymd('2017/7/1'))
  f_therapy_part<-f_therapy_part%>%
    group_by(patid)%>%
    filter((event_date)<=ymd('2017/9/30') & (event_date)>=ymd('2017/7/1'))
  
  events_exac <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% asthma_exacerbations_codes)%>%
    mutate(eventType='exacerbation')
  events_hospitalisation <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% asthma_hospitalisations_codes)%>%
    mutate(eventType='hospitalisation')
  events_respReview <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% resp_review_codes)%>%
    mutate(eventType='respiratoryReview')
  events_OCS <- f_therapy_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% oral_ocs_codes)%>%
    mutate(eventType='OCS')
  events_OtherHospitalisation <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% other_hospitalisation_codes$readcode_new)%>%
    mutate(eventType='OtherHospitalisation')
  events_DefiniteAsthmaCodes <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% definite_asthma_codes$readcode_new)%>%
    mutate(eventType='DefiniteAsthma')
  
   # combine all in one big dataframe
  events_all=rbind(events_exac,events_hospitalisation,events_OCS,events_respReview,events_OtherHospitalisation,events_DefiniteAsthmaCodes)
  rm(events_OCS,events_hospitalisation,events_exac,events_respReview,events_OtherHospitalisation,events_DefiniteAsthmaCodes)
  events_all <-events_all %>%
    arrange(patid,ymd(event_date))
 
 # get id of all patients
  patients_subset<-events_all%>%
    group_by(patid)%>%
    filter(row_number()==1)%>%
    select(patid)
  
  ### Let's start by getting a flag next to OCS,  and Other Hospitalization to confirm if they are present when there was a respiratory review
  
  OCS_Keep_Vector=rep(-1,length(events_all$patid)) 
  events_all$OCS_Keep=OCS_Keep_Vector
   for (kpatient in c(1:length(patients_subset$patid))){
    #print(paste('Processing File Number:',kc,',patient number:',kpatient,',Total Patients:',chunk_size))
    selectedPatient_ID=patients_subset$patid[kpatient]
    I_P=which(events_all$patid==selectedPatient_ID & events_all$eventType=='respiratoryReview')
    I_OCS=which(events_all$patid==selectedPatient_ID & events_all$eventType=='OCS')
    #if no OCS and no respiratory review episodes
    if(length(I_P)==0 & length(I_OCS)==0){
      next
    }
    #if OCS episodes but no respiratory review
    if(length(I_P)==0 & length(I_OCS)>0){
      events_all$OCS_Keep[I_OCS]=1
      next
    }
    #if no OCS episodes but respiratory review
    if(length(I_OCS)==0 & length(I_P)>0){
      events_all$OCS_Keep[I_P]=5
      next
    }
    if(length(I_OCS)>0 & length(I_P)>0) # if both OCS and respiratory review episodes present
    {
      for (k_ocs in c(1:length(I_OCS))) # loop through each OCS episode
      {
        date_OCS=events_all$event_date[I_OCS[k_ocs]]
        date_respReview=events_all$event_date[I_P]
        
        # create two weeks around OCS date interval
        int = interval((ymd(date_OCS)-14),(ymd(date_OCS)+14))
        # check if any respiratory review in interval
        IC=which(ymd(date_respReview) %within% int)
        if(length(IC)>0)
        {
          events_all$OCS_Keep[I_OCS[k_ocs]]=3 # both present and within 2 weeks
        }
        else
        {
          events_all$OCS_Keep[I_OCS[k_ocs]]=2 # both present but not within 2 weeks
        }
      }
    }
    
  }
  
  Hosp_Keep_Vector=rep(-1,length(events_all$patid)) 
  events_all$Hosp_Keep=Hosp_Keep_Vector
   for (kpatient in c(1:length(patients_subset$patid))){
    #print(paste('Processing File Number:',kc,',patient number:',kpatient,',Total Patients:',chunk_size))
    selectedPatient_ID=patients_subset$patid[kpatient]
    I_OH=which(events_all$patid==selectedPatient_ID & events_all$eventType=='OtherHospitalisation')
    I_DA=which(events_all$patid==selectedPatient_ID & events_all$eventType=='DefiniteAsthma')
  
      #if no definite asthma and no other hospitalisation code
    if(length(I_OH)==0 & length(I_DA)==0){
      next
    }
    #if definite asthma but no other hospitalisation code
    if(length(I_OH)==0 & length(I_DA)>0){
      events_all$Hosp_Keep[I_DA]=1
      next
    }
    #if no definite asthma but other hospitalisation code present
    if(length(I_DA)==0 & length(I_OH)>0){
      events_all$Hosp_Keep[I_OH]=2
      next
    }
    if(length(I_DA)>0 & length(I_OH)>0) # if both definite asthma and other hospitalisation present
    {
      dates_OH=events_all$event_date[I_OH]
      dates_DA=events_all$event_date[I_DA]
      IS=which(dates_OH %in% dates_DA) # only get those dates which have definite asthma
      events_all$Hosp_Keep[I_OH[IS]]=3
    }
  }
    

  # let us now extract the outcome from events_all
 
 
  #Asthma Attacks (in 9 months) 
  asthmaAttacks_9months<-events_all%>%
    group_by(patid)%>%
    mutate(outcome_9months=if(any((OCS_Keep==3 & eventType=='OCS')| (Hosp_Keep==3 & eventType=='OtherHospitalisation') | eventType=='exacerbation' | eventType=='hospitalisation'))1 else 0)%>%
    filter(row_number()==1)%>%
    select(patid,outcome_9months) 
  
  save(asthmaAttacks_9months,file=paste('PrepareData/',data_save_folder,'/asthmaAttacks_9months_',kc,'.Rdata',sep=''))
}
```

# outcome 4 : exacerbation attack in 12 months (1st October 2017-31st Dec 2017)
```{r}
rm(list=ls())
library(tidyverse)
library(lubridate)
data_load_folder='ServerData_13Oct2020'
data_save_folder='Outcome_12months'
load('selectedPatients_13Oct2020.Rdata')

# let us now get related codes for hospitalization, LRTI, asthma codes etc.
asthma_exacerbations_codes <- c("Xa1hD", "Xafdy", "Xafdz", "Xafdj","XE0YW","XM0s2","X101y","X1022","H333.","H3301","H3311","H33z0","H33z1") 
asthma_hospitalisations_codes <- c("663m.","663d.", "8H2P.")
resp_review_file = read.csv('./ClinicalCodes/cl_lower_resp_events.txt')
resp_review_codes=resp_review_file$read_code
oral_ocs_codes <- c("fe6..", "fe3..", "fe31.", "fe32.", "fe33.",
                       "fe36.", "fe37.", "fe3A.", "fe3B.", "fe3C.",
                       "fe3r.", "fe3s.", "fe3u.", "fe4..", "fe41.",
                       "fe42.", "fe43.", "fe44.", "fe45.", "fe4e.",
                       "fe4f.", "fe4g.", "fe4h.", "fe5..", "fe51.",
                       "fe52.", "fe53.", "fe5f.", "fe5m.", "fe5n.",
                       "fe5o.", "fe5p.", "fe61.", "fe62.", "fe64.",
                       "fe65.", "fe66.", "fe67.", "fe68.", "fe69.",
                       "fe6a.", "fe6c.", "fe6d.", "fe6e.", "fe6f.",
                       "fe6g.", "fe6h.", "fe6i.", "fe6j.", "fe6k.",
                       "fe6l.", "fe6m.", "fe6n.", "fe6o.", "fe6p.",
                       "fe6q.", "fe6r.", "fe6s.", "fe6t.", "fe6v.",
                       "fe6w.", "fe6z.", "fe7..", "fe71.", "fe72.",
                       "fe73.", "fe74.", "fe75.", "fe76.", "fe77.",
                       "fe78.", "fe79.", "fe7x.", "fe7y.", "fe7z.",
                       "x00yP", "x01Mh", "x01Na", "x01Nb", "fe11.",
                       "fe12.", "fe1x.", "fe1y.", "fe21.", "fe22.",
                       "fe23.", "fe24.", "fe25.", "fe26.", "x01MW")

other_hospitalisation_codes = read.csv('./ClinicalCodes/HospitalisationCodes.csv')
# remove term id from these codes
other_hospitalisation_codes<-other_hospitalisation_codes %>%
  mutate(readcode_new=substr(read_code,1,5))
# also get the specific asthma codes
load('DefiniteAsthmaCodes.Rdata')

# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse', 'lubridate'))%dopar%{
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_clinical_part',kc,'.Rdata',sep='')) 
  load(paste(data_load_folder,'/f_therapy_part',kc,'.Rdata',sep=''))
  
  # first make sure that you are only dealing with data in the appropriate outcome period
  f_clinical_part<-f_clinical_part%>%
    group_by(patid)%>%
    filter((event_date)<=ymd('2017/12/31') & (event_date)>=ymd('2017/10/1'))
  f_therapy_part<-f_therapy_part%>%
    group_by(patid)%>%
    filter((event_date)<=ymd('2017/12/31') & (event_date)>=ymd('2017/10/1'))
  
  events_exac <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% asthma_exacerbations_codes)%>%
    mutate(eventType='exacerbation')
  events_hospitalisation <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% asthma_hospitalisations_codes)%>%
    mutate(eventType='hospitalisation')
  events_respReview <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% resp_review_codes)%>%
    mutate(eventType='respiratoryReview')
  events_OCS <- f_therapy_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% oral_ocs_codes)%>%
    mutate(eventType='OCS')
  events_OtherHospitalisation <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% other_hospitalisation_codes$readcode_new)%>%
    mutate(eventType='OtherHospitalisation')
  events_DefiniteAsthmaCodes <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% definite_asthma_codes$readcode_new)%>%
    mutate(eventType='DefiniteAsthma')
  
   # combine all in one big dataframe
  events_all=rbind(events_exac,events_hospitalisation,events_OCS,events_respReview,events_OtherHospitalisation,events_DefiniteAsthmaCodes)
  rm(events_OCS,events_hospitalisation,events_exac,events_respReview,events_OtherHospitalisation,events_DefiniteAsthmaCodes)
  events_all <-events_all %>%
    arrange(patid,ymd(event_date))
 
 # get id of all patients
  patients_subset<-events_all%>%
    group_by(patid)%>%
    filter(row_number()==1)%>%
    select(patid)
  
  ### Let's start by getting a flag next to OCS,  and Other Hospitalization to confirm if they are present when there was a respiratory review
  
  OCS_Keep_Vector=rep(-1,length(events_all$patid)) 
  events_all$OCS_Keep=OCS_Keep_Vector
   for (kpatient in c(1:length(patients_subset$patid))){
    #print(paste('Processing File Number:',kc,',patient number:',kpatient,',Total Patients:',chunk_size))
    selectedPatient_ID=patients_subset$patid[kpatient]
    I_P=which(events_all$patid==selectedPatient_ID & events_all$eventType=='respiratoryReview')
    I_OCS=which(events_all$patid==selectedPatient_ID & events_all$eventType=='OCS')
    #if no OCS and no respiratory review episodes
    if(length(I_P)==0 & length(I_OCS)==0){
      next
    }
    #if OCS episodes but no respiratory review
    if(length(I_P)==0 & length(I_OCS)>0){
      events_all$OCS_Keep[I_OCS]=1
      next
    }
    #if no OCS episodes but respiratory review
    if(length(I_OCS)==0 & length(I_P)>0){
      events_all$OCS_Keep[I_P]=5
      next
    }
    if(length(I_OCS)>0 & length(I_P)>0) # if both OCS and respiratory review episodes present
    {
      for (k_ocs in c(1:length(I_OCS))) # loop through each OCS episode
      {
        date_OCS=events_all$event_date[I_OCS[k_ocs]]
        date_respReview=events_all$event_date[I_P]
        
        # create two weeks around OCS date interval
        int = interval((ymd(date_OCS)-14),(ymd(date_OCS)+14))
        # check if any respiratory review in interval
        IC=which(ymd(date_respReview) %within% int)
        if(length(IC)>0)
        {
          events_all$OCS_Keep[I_OCS[k_ocs]]=3 # both present and within 2 weeks
        }
        else
        {
          events_all$OCS_Keep[I_OCS[k_ocs]]=2 # both present but not within 2 weeks
        }
      }
    }
    
  }
  
  Hosp_Keep_Vector=rep(-1,length(events_all$patid)) 
  events_all$Hosp_Keep=Hosp_Keep_Vector
   for (kpatient in c(1:length(patients_subset$patid))){
    #print(paste('Processing File Number:',kc,',patient number:',kpatient,',Total Patients:',chunk_size))
    selectedPatient_ID=patients_subset$patid[kpatient]
    I_OH=which(events_all$patid==selectedPatient_ID & events_all$eventType=='OtherHospitalisation')
    I_DA=which(events_all$patid==selectedPatient_ID & events_all$eventType=='DefiniteAsthma')
  
      #if no definite asthma and no other hospitalisation code
    if(length(I_OH)==0 & length(I_DA)==0){
      next
    }
    #if definite asthma but no other hospitalisation code
    if(length(I_OH)==0 & length(I_DA)>0){
      events_all$Hosp_Keep[I_DA]=1
      next
    }
    #if no definite asthma but other hospitalisation code present
    if(length(I_DA)==0 & length(I_OH)>0){
      events_all$Hosp_Keep[I_OH]=2
      next
    }
    if(length(I_DA)>0 & length(I_OH)>0) # if both definite asthma and other hospitalisation present
    {
      dates_OH=events_all$event_date[I_OH]
      dates_DA=events_all$event_date[I_DA]
      IS=which(dates_OH %in% dates_DA) # only get those dates which have definite asthma
      events_all$Hosp_Keep[I_OH[IS]]=3
    }
  }
    

  # let us now extract the outcome from events_all
 
 
  #Asthma Attacks (in 12 months) 
  asthmaAttacks_12months<-events_all%>%
    group_by(patid)%>%
    mutate(outcome_12months=if(any((OCS_Keep==3 & eventType=='OCS')| (Hosp_Keep==3 & eventType=='OtherHospitalisation') | eventType=='exacerbation' | eventType=='hospitalisation'))1 else 0)%>%
    filter(row_number()==1)%>%
    select(patid,outcome_12months) 
  
  save(asthmaAttacks_12months,file=paste('PrepareData/',data_save_folder,'/asthmaAttacks_12months_',kc,'.Rdata',sep=''))
}
```

# outcome 5 : exacerbation attack in 15 months (1st January 2018-31st March 2018)
```{r}
rm(list=ls())
library(tidyverse)
library(lubridate)
data_load_folder='ServerData_13Oct2020'
data_save_folder='Outcome_15months'
load('selectedPatients_13Oct2020.Rdata')

# let us now get related codes for hospitalization, LRTI, asthma codes etc.
asthma_exacerbations_codes <- c("Xa1hD", "Xafdy", "Xafdz", "Xafdj","XE0YW","XM0s2","X101y","X1022","H333.","H3301","H3311","H33z0","H33z1") 
asthma_hospitalisations_codes <- c("663m.","663d.", "8H2P.")
resp_review_file = read.csv('./ClinicalCodes/cl_lower_resp_events.txt')
resp_review_codes=resp_review_file$read_code
oral_ocs_codes <- c("fe6..", "fe3..", "fe31.", "fe32.", "fe33.",
                       "fe36.", "fe37.", "fe3A.", "fe3B.", "fe3C.",
                       "fe3r.", "fe3s.", "fe3u.", "fe4..", "fe41.",
                       "fe42.", "fe43.", "fe44.", "fe45.", "fe4e.",
                       "fe4f.", "fe4g.", "fe4h.", "fe5..", "fe51.",
                       "fe52.", "fe53.", "fe5f.", "fe5m.", "fe5n.",
                       "fe5o.", "fe5p.", "fe61.", "fe62.", "fe64.",
                       "fe65.", "fe66.", "fe67.", "fe68.", "fe69.",
                       "fe6a.", "fe6c.", "fe6d.", "fe6e.", "fe6f.",
                       "fe6g.", "fe6h.", "fe6i.", "fe6j.", "fe6k.",
                       "fe6l.", "fe6m.", "fe6n.", "fe6o.", "fe6p.",
                       "fe6q.", "fe6r.", "fe6s.", "fe6t.", "fe6v.",
                       "fe6w.", "fe6z.", "fe7..", "fe71.", "fe72.",
                       "fe73.", "fe74.", "fe75.", "fe76.", "fe77.",
                       "fe78.", "fe79.", "fe7x.", "fe7y.", "fe7z.",
                       "x00yP", "x01Mh", "x01Na", "x01Nb", "fe11.",
                       "fe12.", "fe1x.", "fe1y.", "fe21.", "fe22.",
                       "fe23.", "fe24.", "fe25.", "fe26.", "x01MW")

other_hospitalisation_codes = read.csv('./ClinicalCodes/HospitalisationCodes.csv')
# remove term id from these codes
other_hospitalisation_codes<-other_hospitalisation_codes %>%
  mutate(readcode_new=substr(read_code,1,5))
# also get the specific asthma codes
load('DefiniteAsthmaCodes.Rdata')

# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse', 'lubridate'))%dopar%{
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_clinical_part',kc,'.Rdata',sep='')) 
  load(paste(data_load_folder,'/f_therapy_part',kc,'.Rdata',sep=''))
  
  # first make sure that you are only dealing with data in the appropriate outcome period
  f_clinical_part<-f_clinical_part%>%
    group_by(patid)%>%
    filter((event_date)<=ymd('2018/3/31') & (event_date)>=ymd('2018/1/1'))
  f_therapy_part<-f_therapy_part%>%
    group_by(patid)%>%
    filter((event_date)<=ymd('2018/3/31') & (event_date)>=ymd('2018/1/1'))
  
  events_exac <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% asthma_exacerbations_codes)%>%
    mutate(eventType='exacerbation')
  events_hospitalisation <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% asthma_hospitalisations_codes)%>%
    mutate(eventType='hospitalisation')
  events_respReview <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% resp_review_codes)%>%
    mutate(eventType='respiratoryReview')
  events_OCS <- f_therapy_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% oral_ocs_codes)%>%
    mutate(eventType='OCS')
  events_OtherHospitalisation <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% other_hospitalisation_codes$readcode_new)%>%
    mutate(eventType='OtherHospitalisation')
  events_DefiniteAsthmaCodes <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% definite_asthma_codes$readcode_new)%>%
    mutate(eventType='DefiniteAsthma')
  
   # combine all in one big dataframe
  events_all=rbind(events_exac,events_hospitalisation,events_OCS,events_respReview,events_OtherHospitalisation,events_DefiniteAsthmaCodes)
  rm(events_OCS,events_hospitalisation,events_exac,events_respReview,events_OtherHospitalisation,events_DefiniteAsthmaCodes)
  events_all <-events_all %>%
    arrange(patid,ymd(event_date))
 
 # get id of all patients
  patients_subset<-events_all%>%
    group_by(patid)%>%
    filter(row_number()==1)%>%
    select(patid)
  
  ### Let's start by getting a flag next to OCS,  and Other Hospitalization to confirm if they are present when there was a respiratory review
  
  OCS_Keep_Vector=rep(-1,length(events_all$patid)) 
  events_all$OCS_Keep=OCS_Keep_Vector
   for (kpatient in c(1:length(patients_subset$patid))){
    #print(paste('Processing File Number:',kc,',patient number:',kpatient,',Total Patients:',chunk_size))
    selectedPatient_ID=patients_subset$patid[kpatient]
    I_P=which(events_all$patid==selectedPatient_ID & events_all$eventType=='respiratoryReview')
    I_OCS=which(events_all$patid==selectedPatient_ID & events_all$eventType=='OCS')
    #if no OCS and no respiratory review episodes
    if(length(I_P)==0 & length(I_OCS)==0){
      next
    }
    #if OCS episodes but no respiratory review
    if(length(I_P)==0 & length(I_OCS)>0){
      events_all$OCS_Keep[I_OCS]=1
      next
    }
    #if no OCS episodes but respiratory review
    if(length(I_OCS)==0 & length(I_P)>0){
      events_all$OCS_Keep[I_P]=5
      next
    }
    if(length(I_OCS)>0 & length(I_P)>0) # if both OCS and respiratory review episodes present
    {
      for (k_ocs in c(1:length(I_OCS))) # loop through each OCS episode
      {
        date_OCS=events_all$event_date[I_OCS[k_ocs]]
        date_respReview=events_all$event_date[I_P]
        
        # create two weeks around OCS date interval
        int = interval((ymd(date_OCS)-14),(ymd(date_OCS)+14))
        # check if any respiratory review in interval
        IC=which(ymd(date_respReview) %within% int)
        if(length(IC)>0)
        {
          events_all$OCS_Keep[I_OCS[k_ocs]]=3 # both present and within 2 weeks
        }
        else
        {
          events_all$OCS_Keep[I_OCS[k_ocs]]=2 # both present but not within 2 weeks
        }
      }
    }
    
  }
  
  Hosp_Keep_Vector=rep(-1,length(events_all$patid)) 
  events_all$Hosp_Keep=Hosp_Keep_Vector
   for (kpatient in c(1:length(patients_subset$patid))){
    #print(paste('Processing File Number:',kc,',patient number:',kpatient,',Total Patients:',chunk_size))
    selectedPatient_ID=patients_subset$patid[kpatient]
    I_OH=which(events_all$patid==selectedPatient_ID & events_all$eventType=='OtherHospitalisation')
    I_DA=which(events_all$patid==selectedPatient_ID & events_all$eventType=='DefiniteAsthma')
  
      #if no definite asthma and no other hospitalisation code
    if(length(I_OH)==0 & length(I_DA)==0){
      next
    }
    #if definite asthma but no other hospitalisation code
    if(length(I_OH)==0 & length(I_DA)>0){
      events_all$Hosp_Keep[I_DA]=1
      next
    }
    #if no definite asthma but other hospitalisation code present
    if(length(I_DA)==0 & length(I_OH)>0){
      events_all$Hosp_Keep[I_OH]=2
      next
    }
    if(length(I_DA)>0 & length(I_OH)>0) # if both definite asthma and other hospitalisation present
    {
      dates_OH=events_all$event_date[I_OH]
      dates_DA=events_all$event_date[I_DA]
      IS=which(dates_OH %in% dates_DA) # only get those dates which have definite asthma
      events_all$Hosp_Keep[I_OH[IS]]=3
    }
  }
    

  # let us now extract the outcome from events_all
 
 
  #Asthma Attacks (in 15 months) 
  asthmaAttacks_15months<-events_all%>%
    group_by(patid)%>%
    mutate(outcome_15months=if(any((OCS_Keep==3 & eventType=='OCS')| (Hosp_Keep==3 & eventType=='OtherHospitalisation') | eventType=='exacerbation' | eventType=='hospitalisation'))1 else 0)%>%
    filter(row_number()==1)%>%
    select(patid,outcome_15months) 
  
  save(asthmaAttacks_15months,file=paste('PrepareData/',data_save_folder,'/asthmaAttacks_15months_',kc,'.Rdata',sep=''))
}
```

# outcome 6 : exacerbation attack in 18 months (1st April 2018-30th June 2018)
```{r}
rm(list=ls())
library(tidyverse)
library(lubridate)
data_load_folder='ServerData_13Oct2020'
data_save_folder='Outcome_18months'
load('selectedPatients_13Oct2020.Rdata')

# let us now get related codes for hospitalization, LRTI, asthma codes etc.
asthma_exacerbations_codes <- c("Xa1hD", "Xafdy", "Xafdz", "Xafdj","XE0YW","XM0s2","X101y","X1022","H333.","H3301","H3311","H33z0","H33z1") 
asthma_hospitalisations_codes <- c("663m.","663d.", "8H2P.")
resp_review_file = read.csv('./ClinicalCodes/cl_lower_resp_events.txt')
resp_review_codes=resp_review_file$read_code
oral_ocs_codes <- c("fe6..", "fe3..", "fe31.", "fe32.", "fe33.",
                       "fe36.", "fe37.", "fe3A.", "fe3B.", "fe3C.",
                       "fe3r.", "fe3s.", "fe3u.", "fe4..", "fe41.",
                       "fe42.", "fe43.", "fe44.", "fe45.", "fe4e.",
                       "fe4f.", "fe4g.", "fe4h.", "fe5..", "fe51.",
                       "fe52.", "fe53.", "fe5f.", "fe5m.", "fe5n.",
                       "fe5o.", "fe5p.", "fe61.", "fe62.", "fe64.",
                       "fe65.", "fe66.", "fe67.", "fe68.", "fe69.",
                       "fe6a.", "fe6c.", "fe6d.", "fe6e.", "fe6f.",
                       "fe6g.", "fe6h.", "fe6i.", "fe6j.", "fe6k.",
                       "fe6l.", "fe6m.", "fe6n.", "fe6o.", "fe6p.",
                       "fe6q.", "fe6r.", "fe6s.", "fe6t.", "fe6v.",
                       "fe6w.", "fe6z.", "fe7..", "fe71.", "fe72.",
                       "fe73.", "fe74.", "fe75.", "fe76.", "fe77.",
                       "fe78.", "fe79.", "fe7x.", "fe7y.", "fe7z.",
                       "x00yP", "x01Mh", "x01Na", "x01Nb", "fe11.",
                       "fe12.", "fe1x.", "fe1y.", "fe21.", "fe22.",
                       "fe23.", "fe24.", "fe25.", "fe26.", "x01MW")

other_hospitalisation_codes = read.csv('./ClinicalCodes/HospitalisationCodes.csv')
# remove term id from these codes
other_hospitalisation_codes<-other_hospitalisation_codes %>%
  mutate(readcode_new=substr(read_code,1,5))
# also get the specific asthma codes
load('DefiniteAsthmaCodes.Rdata')

# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse', 'lubridate'))%dopar%{
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_clinical_part',kc,'.Rdata',sep='')) 
  load(paste(data_load_folder,'/f_therapy_part',kc,'.Rdata',sep=''))
  
  # first make sure that you are only dealing with data in the appropriate outcome period
  f_clinical_part<-f_clinical_part%>%
    group_by(patid)%>%
    filter((event_date)<=ymd('2018/6/30') & (event_date)>=ymd('2018/4/1'))
  f_therapy_part<-f_therapy_part%>%
    group_by(patid)%>%
    filter((event_date)<=ymd('2018/6/30') & (event_date)>=ymd('2018/4/1'))
  
  events_exac <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% asthma_exacerbations_codes)%>%
    mutate(eventType='exacerbation')
  events_hospitalisation <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% asthma_hospitalisations_codes)%>%
    mutate(eventType='hospitalisation')
  events_respReview <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% resp_review_codes)%>%
    mutate(eventType='respiratoryReview')
  events_OCS <- f_therapy_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% oral_ocs_codes)%>%
    mutate(eventType='OCS')
  events_OtherHospitalisation <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% other_hospitalisation_codes$readcode_new)%>%
    mutate(eventType='OtherHospitalisation')
  events_DefiniteAsthmaCodes <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% definite_asthma_codes$readcode_new)%>%
    mutate(eventType='DefiniteAsthma')
  
   # combine all in one big dataframe
  events_all=rbind(events_exac,events_hospitalisation,events_OCS,events_respReview,events_OtherHospitalisation,events_DefiniteAsthmaCodes)
  rm(events_OCS,events_hospitalisation,events_exac,events_respReview,events_OtherHospitalisation,events_DefiniteAsthmaCodes)
  events_all <-events_all %>%
    arrange(patid,ymd(event_date))
 
 # get id of all patients
  patients_subset<-events_all%>%
    group_by(patid)%>%
    filter(row_number()==1)%>%
    select(patid)
  
  ### Let's start by getting a flag next to OCS,  and Other Hospitalization to confirm if they are present when there was a respiratory review
  
  OCS_Keep_Vector=rep(-1,length(events_all$patid)) 
  events_all$OCS_Keep=OCS_Keep_Vector
   for (kpatient in c(1:length(patients_subset$patid))){
    #print(paste('Processing File Number:',kc,',patient number:',kpatient,',Total Patients:',chunk_size))
    selectedPatient_ID=patients_subset$patid[kpatient]
    I_P=which(events_all$patid==selectedPatient_ID & events_all$eventType=='respiratoryReview')
    I_OCS=which(events_all$patid==selectedPatient_ID & events_all$eventType=='OCS')
    #if no OCS and no respiratory review episodes
    if(length(I_P)==0 & length(I_OCS)==0){
      next
    }
    #if OCS episodes but no respiratory review
    if(length(I_P)==0 & length(I_OCS)>0){
      events_all$OCS_Keep[I_OCS]=1
      next
    }
    #if no OCS episodes but respiratory review
    if(length(I_OCS)==0 & length(I_P)>0){
      events_all$OCS_Keep[I_P]=5
      next
    }
    if(length(I_OCS)>0 & length(I_P)>0) # if both OCS and respiratory review episodes present
    {
      for (k_ocs in c(1:length(I_OCS))) # loop through each OCS episode
      {
        date_OCS=events_all$event_date[I_OCS[k_ocs]]
        date_respReview=events_all$event_date[I_P]
        
        # create two weeks around OCS date interval
        int = interval((ymd(date_OCS)-14),(ymd(date_OCS)+14))
        # check if any respiratory review in interval
        IC=which(ymd(date_respReview) %within% int)
        if(length(IC)>0)
        {
          events_all$OCS_Keep[I_OCS[k_ocs]]=3 # both present and within 2 weeks
        }
        else
        {
          events_all$OCS_Keep[I_OCS[k_ocs]]=2 # both present but not within 2 weeks
        }
      }
    }
    
  }
  
  Hosp_Keep_Vector=rep(-1,length(events_all$patid)) 
  events_all$Hosp_Keep=Hosp_Keep_Vector
   for (kpatient in c(1:length(patients_subset$patid))){
    #print(paste('Processing File Number:',kc,',patient number:',kpatient,',Total Patients:',chunk_size))
    selectedPatient_ID=patients_subset$patid[kpatient]
    I_OH=which(events_all$patid==selectedPatient_ID & events_all$eventType=='OtherHospitalisation')
    I_DA=which(events_all$patid==selectedPatient_ID & events_all$eventType=='DefiniteAsthma')
  
      #if no definite asthma and no other hospitalisation code
    if(length(I_OH)==0 & length(I_DA)==0){
      next
    }
    #if definite asthma but no other hospitalisation code
    if(length(I_OH)==0 & length(I_DA)>0){
      events_all$Hosp_Keep[I_DA]=1
      next
    }
    #if no definite asthma but other hospitalisation code present
    if(length(I_DA)==0 & length(I_OH)>0){
      events_all$Hosp_Keep[I_OH]=2
      next
    }
    if(length(I_DA)>0 & length(I_OH)>0) # if both definite asthma and other hospitalisation present
    {
      dates_OH=events_all$event_date[I_OH]
      dates_DA=events_all$event_date[I_DA]
      IS=which(dates_OH %in% dates_DA) # only get those dates which have definite asthma
      events_all$Hosp_Keep[I_OH[IS]]=3
    }
  }
    

  # let us now extract the outcome from events_all
 
 
  #Asthma Attacks (in 18 months) 
  asthmaAttacks_18months<-events_all%>%
    group_by(patid)%>%
    mutate(outcome_18months=if(any((OCS_Keep==3 & eventType=='OCS')| (Hosp_Keep==3 & eventType=='OtherHospitalisation') | eventType=='exacerbation' | eventType=='hospitalisation'))1 else 0)%>%
    filter(row_number()==1)%>%
    select(patid,outcome_18months) 
  
  save(asthmaAttacks_18months,file=paste('PrepareData/',data_save_folder,'/asthmaAttacks_18months_',kc,'.Rdata',sep=''))
}
```

# outcome 7 : exacerbation attack in 21 months (1st July 2018-30th Sep 2018)
```{r}
rm(list=ls())
library(tidyverse)
library(lubridate)
data_load_folder='ServerData_13Oct2020'
data_save_folder='Outcome_21months'
load('selectedPatients_13Oct2020.Rdata')

# let us now get related codes for hospitalization, LRTI, asthma codes etc.
asthma_exacerbations_codes <- c("Xa1hD", "Xafdy", "Xafdz", "Xafdj","XE0YW","XM0s2","X101y","X1022","H333.","H3301","H3311","H33z0","H33z1") 
asthma_hospitalisations_codes <- c("663m.","663d.", "8H2P.")
resp_review_file = read.csv('./ClinicalCodes/cl_lower_resp_events.txt')
resp_review_codes=resp_review_file$read_code
oral_ocs_codes <- c("fe6..", "fe3..", "fe31.", "fe32.", "fe33.",
                       "fe36.", "fe37.", "fe3A.", "fe3B.", "fe3C.",
                       "fe3r.", "fe3s.", "fe3u.", "fe4..", "fe41.",
                       "fe42.", "fe43.", "fe44.", "fe45.", "fe4e.",
                       "fe4f.", "fe4g.", "fe4h.", "fe5..", "fe51.",
                       "fe52.", "fe53.", "fe5f.", "fe5m.", "fe5n.",
                       "fe5o.", "fe5p.", "fe61.", "fe62.", "fe64.",
                       "fe65.", "fe66.", "fe67.", "fe68.", "fe69.",
                       "fe6a.", "fe6c.", "fe6d.", "fe6e.", "fe6f.",
                       "fe6g.", "fe6h.", "fe6i.", "fe6j.", "fe6k.",
                       "fe6l.", "fe6m.", "fe6n.", "fe6o.", "fe6p.",
                       "fe6q.", "fe6r.", "fe6s.", "fe6t.", "fe6v.",
                       "fe6w.", "fe6z.", "fe7..", "fe71.", "fe72.",
                       "fe73.", "fe74.", "fe75.", "fe76.", "fe77.",
                       "fe78.", "fe79.", "fe7x.", "fe7y.", "fe7z.",
                       "x00yP", "x01Mh", "x01Na", "x01Nb", "fe11.",
                       "fe12.", "fe1x.", "fe1y.", "fe21.", "fe22.",
                       "fe23.", "fe24.", "fe25.", "fe26.", "x01MW")

other_hospitalisation_codes = read.csv('./ClinicalCodes/HospitalisationCodes.csv')
# remove term id from these codes
other_hospitalisation_codes<-other_hospitalisation_codes %>%
  mutate(readcode_new=substr(read_code,1,5))
# also get the specific asthma codes
load('DefiniteAsthmaCodes.Rdata')

# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse', 'lubridate'))%dopar%{
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_clinical_part',kc,'.Rdata',sep='')) 
  load(paste(data_load_folder,'/f_therapy_part',kc,'.Rdata',sep=''))
  
  # first make sure that you are only dealing with data in the appropriate outcome period
  f_clinical_part<-f_clinical_part%>%
    group_by(patid)%>%
    filter((event_date)<=ymd('2018/9/30') & (event_date)>=ymd('2018/7/1'))
  f_therapy_part<-f_therapy_part%>%
    group_by(patid)%>%
    filter((event_date)<=ymd('2018/9/30') & (event_date)>=ymd('2018/7/1'))
  
  events_exac <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% asthma_exacerbations_codes)%>%
    mutate(eventType='exacerbation')
  events_hospitalisation <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% asthma_hospitalisations_codes)%>%
    mutate(eventType='hospitalisation')
  events_respReview <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% resp_review_codes)%>%
    mutate(eventType='respiratoryReview')
  events_OCS <- f_therapy_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% oral_ocs_codes)%>%
    mutate(eventType='OCS')
  events_OtherHospitalisation <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% other_hospitalisation_codes$readcode_new)%>%
    mutate(eventType='OtherHospitalisation')
  events_DefiniteAsthmaCodes <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% definite_asthma_codes$readcode_new)%>%
    mutate(eventType='DefiniteAsthma')
  
   # combine all in one big dataframe
  events_all=rbind(events_exac,events_hospitalisation,events_OCS,events_respReview,events_OtherHospitalisation,events_DefiniteAsthmaCodes)
  rm(events_OCS,events_hospitalisation,events_exac,events_respReview,events_OtherHospitalisation,events_DefiniteAsthmaCodes)
  events_all <-events_all %>%
    arrange(patid,ymd(event_date))
 
 # get id of all patients
  patients_subset<-events_all%>%
    group_by(patid)%>%
    filter(row_number()==1)%>%
    select(patid)
  
  ### Let's start by getting a flag next to OCS,  and Other Hospitalization to confirm if they are present when there was a respiratory review
  
  OCS_Keep_Vector=rep(-1,length(events_all$patid)) 
  events_all$OCS_Keep=OCS_Keep_Vector
   for (kpatient in c(1:length(patients_subset$patid))){
    #print(paste('Processing File Number:',kc,',patient number:',kpatient,',Total Patients:',chunk_size))
    selectedPatient_ID=patients_subset$patid[kpatient]
    I_P=which(events_all$patid==selectedPatient_ID & events_all$eventType=='respiratoryReview')
    I_OCS=which(events_all$patid==selectedPatient_ID & events_all$eventType=='OCS')
    #if no OCS and no respiratory review episodes
    if(length(I_P)==0 & length(I_OCS)==0){
      next
    }
    #if OCS episodes but no respiratory review
    if(length(I_P)==0 & length(I_OCS)>0){
      events_all$OCS_Keep[I_OCS]=1
      next
    }
    #if no OCS episodes but respiratory review
    if(length(I_OCS)==0 & length(I_P)>0){
      events_all$OCS_Keep[I_P]=5
      next
    }
    if(length(I_OCS)>0 & length(I_P)>0) # if both OCS and respiratory review episodes present
    {
      for (k_ocs in c(1:length(I_OCS))) # loop through each OCS episode
      {
        date_OCS=events_all$event_date[I_OCS[k_ocs]]
        date_respReview=events_all$event_date[I_P]
        
        # create two weeks around OCS date interval
        int = interval((ymd(date_OCS)-14),(ymd(date_OCS)+14))
        # check if any respiratory review in interval
        IC=which(ymd(date_respReview) %within% int)
        if(length(IC)>0)
        {
          events_all$OCS_Keep[I_OCS[k_ocs]]=3 # both present and within 2 weeks
        }
        else
        {
          events_all$OCS_Keep[I_OCS[k_ocs]]=2 # both present but not within 2 weeks
        }
      }
    }
    
  }
  
  Hosp_Keep_Vector=rep(-1,length(events_all$patid)) 
  events_all$Hosp_Keep=Hosp_Keep_Vector
   for (kpatient in c(1:length(patients_subset$patid))){
    #print(paste('Processing File Number:',kc,',patient number:',kpatient,',Total Patients:',chunk_size))
    selectedPatient_ID=patients_subset$patid[kpatient]
    I_OH=which(events_all$patid==selectedPatient_ID & events_all$eventType=='OtherHospitalisation')
    I_DA=which(events_all$patid==selectedPatient_ID & events_all$eventType=='DefiniteAsthma')
  
      #if no definite asthma and no other hospitalisation code
    if(length(I_OH)==0 & length(I_DA)==0){
      next
    }
    #if definite asthma but no other hospitalisation code
    if(length(I_OH)==0 & length(I_DA)>0){
      events_all$Hosp_Keep[I_DA]=1
      next
    }
    #if no definite asthma but other hospitalisation code present
    if(length(I_DA)==0 & length(I_OH)>0){
      events_all$Hosp_Keep[I_OH]=2
      next
    }
    if(length(I_DA)>0 & length(I_OH)>0) # if both definite asthma and other hospitalisation present
    {
      dates_OH=events_all$event_date[I_OH]
      dates_DA=events_all$event_date[I_DA]
      IS=which(dates_OH %in% dates_DA) # only get those dates which have definite asthma
      events_all$Hosp_Keep[I_OH[IS]]=3
    }
  }
    

  # let us now extract the outcome from events_all
 
 
  #Asthma Attacks (in 21 months) 
  asthmaAttacks_21months<-events_all%>%
    group_by(patid)%>%
    mutate(outcome_21months=if(any((OCS_Keep==3 & eventType=='OCS')| (Hosp_Keep==3 & eventType=='OtherHospitalisation') | eventType=='exacerbation' | eventType=='hospitalisation'))1 else 0)%>%
    filter(row_number()==1)%>%
    select(patid,outcome_21months) 
  
  save(asthmaAttacks_21months,file=paste('PrepareData/',data_save_folder,'/asthmaAttacks_21months_',kc,'.Rdata',sep=''))
}
```

# outcome 8 : exacerbation attack in 24 months (1st Oct 2018-31st Dec 2018)
```{r}
rm(list=ls())
library(tidyverse)
library(lubridate)
data_load_folder='ServerData_13Oct2020'
data_save_folder='Outcome_24months'
load('selectedPatients_13Oct2020.Rdata')

# let us now get related codes for hospitalization, LRTI, asthma codes etc.
asthma_exacerbations_codes <- c("Xa1hD", "Xafdy", "Xafdz", "Xafdj","XE0YW","XM0s2","X101y","X1022","H333.","H3301","H3311","H33z0","H33z1") 
asthma_hospitalisations_codes <- c("663m.","663d.", "8H2P.")
resp_review_file = read.csv('./ClinicalCodes/cl_lower_resp_events.txt')
resp_review_codes=resp_review_file$read_code
oral_ocs_codes <- c("fe6..", "fe3..", "fe31.", "fe32.", "fe33.",
                       "fe36.", "fe37.", "fe3A.", "fe3B.", "fe3C.",
                       "fe3r.", "fe3s.", "fe3u.", "fe4..", "fe41.",
                       "fe42.", "fe43.", "fe44.", "fe45.", "fe4e.",
                       "fe4f.", "fe4g.", "fe4h.", "fe5..", "fe51.",
                       "fe52.", "fe53.", "fe5f.", "fe5m.", "fe5n.",
                       "fe5o.", "fe5p.", "fe61.", "fe62.", "fe64.",
                       "fe65.", "fe66.", "fe67.", "fe68.", "fe69.",
                       "fe6a.", "fe6c.", "fe6d.", "fe6e.", "fe6f.",
                       "fe6g.", "fe6h.", "fe6i.", "fe6j.", "fe6k.",
                       "fe6l.", "fe6m.", "fe6n.", "fe6o.", "fe6p.",
                       "fe6q.", "fe6r.", "fe6s.", "fe6t.", "fe6v.",
                       "fe6w.", "fe6z.", "fe7..", "fe71.", "fe72.",
                       "fe73.", "fe74.", "fe75.", "fe76.", "fe77.",
                       "fe78.", "fe79.", "fe7x.", "fe7y.", "fe7z.",
                       "x00yP", "x01Mh", "x01Na", "x01Nb", "fe11.",
                       "fe12.", "fe1x.", "fe1y.", "fe21.", "fe22.",
                       "fe23.", "fe24.", "fe25.", "fe26.", "x01MW")

other_hospitalisation_codes = read.csv('./ClinicalCodes/HospitalisationCodes.csv')
# remove term id from these codes
other_hospitalisation_codes<-other_hospitalisation_codes %>%
  mutate(readcode_new=substr(read_code,1,5))
# also get the specific asthma codes
load('DefiniteAsthmaCodes.Rdata')

# use the same chunk size that was used during patient selection so that num_files is correctly calculated and you are able to use data from all the selected patients
chunk_size=10000
num_files=ceiling(length(selectedPatients$patid)/chunk_size)
num_patients=length(selectedPatients$patid)
foreach (kc = 1:num_files, .packages=c('tictoc', 'tidyverse', 'lubridate'))%dopar%{
  print(paste('Processing File Number:',kc,', Total files:',num_files))
  load(paste(data_load_folder,'/f_clinical_part',kc,'.Rdata',sep='')) 
  load(paste(data_load_folder,'/f_therapy_part',kc,'.Rdata',sep=''))
  
  # first make sure that you are only dealing with data in the appropriate outcome period
  f_clinical_part<-f_clinical_part%>%
    group_by(patid)%>%
    filter((event_date)<=ymd('2018/12/31') & (event_date)>=ymd('2018/10/1'))
  f_therapy_part<-f_therapy_part%>%
    group_by(patid)%>%
    filter((event_date)<=ymd('2018/12/31') & (event_date)>=ymd('2018/10/1'))
  
  events_exac <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% asthma_exacerbations_codes)%>%
    mutate(eventType='exacerbation')
  events_hospitalisation <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% asthma_hospitalisations_codes)%>%
    mutate(eventType='hospitalisation')
  events_respReview <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% resp_review_codes)%>%
    mutate(eventType='respiratoryReview')
  events_OCS <- f_therapy_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% oral_ocs_codes)%>%
    mutate(eventType='OCS')
  events_OtherHospitalisation <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% other_hospitalisation_codes$readcode_new)%>%
    mutate(eventType='OtherHospitalisation')
  events_DefiniteAsthmaCodes <- f_clinical_part %>%
    select(patid,event_date,code_id) %>%
    filter(code_id %in% definite_asthma_codes$readcode_new)%>%
    mutate(eventType='DefiniteAsthma')
  
   # combine all in one big dataframe
  events_all=rbind(events_exac,events_hospitalisation,events_OCS,events_respReview,events_OtherHospitalisation,events_DefiniteAsthmaCodes)
  rm(events_OCS,events_hospitalisation,events_exac,events_respReview,events_OtherHospitalisation,events_DefiniteAsthmaCodes)
  events_all <-events_all %>%
    arrange(patid,ymd(event_date))
 
 # get id of all patients
  patients_subset<-events_all%>%
    group_by(patid)%>%
    filter(row_number()==1)%>%
    select(patid)
  
  ### Let's start by getting a flag next to OCS,  and Other Hospitalization to confirm if they are present when there was a respiratory review
  
  OCS_Keep_Vector=rep(-1,length(events_all$patid)) 
  events_all$OCS_Keep=OCS_Keep_Vector
   for (kpatient in c(1:length(patients_subset$patid))){
    #print(paste('Processing File Number:',kc,',patient number:',kpatient,',Total Patients:',chunk_size))
    selectedPatient_ID=patients_subset$patid[kpatient]
    I_P=which(events_all$patid==selectedPatient_ID & events_all$eventType=='respiratoryReview')
    I_OCS=which(events_all$patid==selectedPatient_ID & events_all$eventType=='OCS')
    #if no OCS and no respiratory review episodes
    if(length(I_P)==0 & length(I_OCS)==0){
      next
    }
    #if OCS episodes but no respiratory review
    if(length(I_P)==0 & length(I_OCS)>0){
      events_all$OCS_Keep[I_OCS]=1
      next
    }
    #if no OCS episodes but respiratory review
    if(length(I_OCS)==0 & length(I_P)>0){
      events_all$OCS_Keep[I_P]=5
      next
    }
    if(length(I_OCS)>0 & length(I_P)>0) # if both OCS and respiratory review episodes present
    {
      for (k_ocs in c(1:length(I_OCS))) # loop through each OCS episode
      {
        date_OCS=events_all$event_date[I_OCS[k_ocs]]
        date_respReview=events_all$event_date[I_P]
        
        # create two weeks around OCS date interval
        int = interval((ymd(date_OCS)-14),(ymd(date_OCS)+14))
        # check if any respiratory review in interval
        IC=which(ymd(date_respReview) %within% int)
        if(length(IC)>0)
        {
          events_all$OCS_Keep[I_OCS[k_ocs]]=3 # both present and within 2 weeks
        }
        else
        {
          events_all$OCS_Keep[I_OCS[k_ocs]]=2 # both present but not within 2 weeks
        }
      }
    }
    
  }
  
  Hosp_Keep_Vector=rep(-1,length(events_all$patid)) 
  events_all$Hosp_Keep=Hosp_Keep_Vector
   for (kpatient in c(1:length(patients_subset$patid))){
    #print(paste('Processing File Number:',kc,',patient number:',kpatient,',Total Patients:',chunk_size))
    selectedPatient_ID=patients_subset$patid[kpatient]
    I_OH=which(events_all$patid==selectedPatient_ID & events_all$eventType=='OtherHospitalisation')
    I_DA=which(events_all$patid==selectedPatient_ID & events_all$eventType=='DefiniteAsthma')
  
      #if no definite asthma and no other hospitalisation code
    if(length(I_OH)==0 & length(I_DA)==0){
      next
    }
    #if definite asthma but no other hospitalisation code
    if(length(I_OH)==0 & length(I_DA)>0){
      events_all$Hosp_Keep[I_DA]=1
      next
    }
    #if no definite asthma but other hospitalisation code present
    if(length(I_DA)==0 & length(I_OH)>0){
      events_all$Hosp_Keep[I_OH]=2
      next
    }
    if(length(I_DA)>0 & length(I_OH)>0) # if both definite asthma and other hospitalisation present
    {
      dates_OH=events_all$event_date[I_OH]
      dates_DA=events_all$event_date[I_DA]
      IS=which(dates_OH %in% dates_DA) # only get those dates which have definite asthma
      events_all$Hosp_Keep[I_OH[IS]]=3
    }
  }
    

  # let us now extract the outcome from events_all
 
 
  #Asthma Attacks (in 24 months) 
  asthmaAttacks_24months<-events_all%>%
    group_by(patid)%>%
    mutate(outcome_24months=if(any((OCS_Keep==3 & eventType=='OCS')| (Hosp_Keep==3 & eventType=='OtherHospitalisation') | eventType=='exacerbation' | eventType=='hospitalisation'))1 else 0)%>%
    filter(row_number()==1)%>%
    select(patid,outcome_24months) 
  
  save(asthmaAttacks_24months,file=paste('PrepareData/',data_save_folder,'/asthmaAttacks_24months_',kc,'.Rdata',sep=''))
}
```

Now that we have extracted various features
